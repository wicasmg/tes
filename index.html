<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Learning Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <!-- Import Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Import Quill JS and CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Import SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- Import SortableJS for Drag and Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        #login-page {
            background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://blogger.googleusercontent.com/img/a/AVvXsEjv_fAqvn09BccXUdb07YFvx8n5tcm6P7RSF6HSTpV4LjfgZ4srpEU90FYYiRTfxBf7TCzqNsHs0uZdGVrYHutDIvxW_-VbYbfXWh2ndE_7K-y4eE01M5XvEf0tDL1tAHMnQWDujEwe6y5hsbgLdGfpqHHNeHuv0PCCtHNta549Dcnw1PxFzrQkkg3lP0xX');
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
        }

        /* Animasi Bentuk Melayang di Latar Belakang */
        #login-page::before,
        #login-page::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            opacity: 0.15;
            z-index: 0;
            animation: float 20s infinite alternate;
            filter: blur(40px);
        }

        #login-page::before {
            width: 300px;
            height: 300px;
            background: #a3bffa;
            top: 10%;
            left: 15%;
        }

        #login-page::after {
            width: 200px;
            height: 200px;
            background: #d5aaff;
            bottom: 15%;
            right: 20%;
            animation-duration: 25s;
            animation-delay: -5s;
        }

        @keyframes float {
            0% { transform: translateY(0px) translateX(0px) rotate(0deg); }
            100% { transform: translateY(-50px) translateX(20px) rotate(20deg); }
        }

        /* Kotak Login Transparan (Glassmorphism) */
        #login-page .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 1;
        }

        /* Input field transparan */
        #login-page input[type="text"],
        #login-page input[type="password"] {
            background-color: rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
        }
        #login-page input[type="text"]::placeholder,
        #login-page input[type="password"]::placeholder {
          color: rgba(255, 255, 255, 0.6);
          opacity: 1;
        }

        #login-page input[type="text"]:focus,
        #login-page input[type="password"]:focus {
            background-color: rgba(0, 0, 0, 0.3);
            border-color: #a3bffa;
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.4);
        }

        /* Efek visual saat tombol di-hover */
        .btn-hover-effect {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }

        .btn-hover-effect:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Styling untuk Active Sidebar Link */
        .lecturer-sidebar-link.active {
            background-color: #eef2ff; /* indigo-50 */
            color: #4f46e5; /* indigo-700 */
            font-weight: 600;
        }
        
        /* Animasi Gradien Teks untuk Jam */
        @keyframes animate-text-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .animated-clock-text {
            background: linear-gradient(-45deg, #a3bffa, #d5aaff, #a3bffa);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: animate-text-gradient 8s ease infinite;
        }

        /* Styling yang sudah ada */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .transition-all {
            transition: all 0.3s ease;
        }
        #notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 1050;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #notification.show {
            opacity: 1;
            visibility: visible;
        }
        #notification.success { background-color: #10B981; }
        #notification.error { background-color: #EF4444; }
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(107, 114, 128, 0.75);
            z-index: 40;
        }
        .modal { z-index: 50; }
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
        #editor-container {
            height: 250px;
        }
        .ql-editor {
            font-size: 16px;
        }
        .ql-editor.ql-blank::before {
            color: #a0aec0;
        }
        .module-item.active {
            background-color: #334155; /* slate-700 */
            color: #FFFFFF;
        }
        .sortable-ghost {
            opacity: 0.4;
            background-color: #eef2ff;
        }
        .drag-handle {
            cursor: move;
        }
        /* Style untuk video responsif */
        .responsive-video-embed {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        }
        .responsive-video-embed iframe,
        .responsive-video-embed video { /* Apply to both iframe and video */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
/* PERBAIKAN: Biarkan klik "tembus" melewati ikon SVG ke tombol */
    [data-feather] {
        pointer-events: none;
    }
    </style>
</head>
<body class="min-h-screen bg-gray-100">
    <div id="app" class="flex flex-col min-h-screen">
        <!-- Login Page -->
        <div id="login-page" class="flex flex-col items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-md glass-card rounded-lg shadow-xl overflow-hidden" data-aos="fade-up">
                <div class="px-6 py-8">
                    <div class="flex justify-center mb-8">
                        <div class="bg-indigo-100 p-4 rounded-full">
                            <i data-feather="book" class="text-indigo-600 w-10 h-10"></i>
                        </div>
                    </div>
                    <h2 class="text-3xl font-bold text-center text-white mb-2">English Learning Platform</h2>
                    <p class="text-center text-gray-200 mb-8">AMNI Maritime University</p>
                    
                    <form id="login-form" class="space-y-6">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-200 mb-1">Username (Student ID)</label>
                            <input type="text" id="username" required class="w-full px-4 py-2 border rounded-md focus:outline-none transition-all">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-200 mb-1">Password</label>
                            <input type="password" id="password" required class="w-full px-4 py-2 border rounded-md focus:outline-none transition-all">
                        </div>
                        <div>
                            <button type="submit" class="w-full gradient-bg text-white py-2 px-4 rounded-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 btn-hover-effect">
                                Sign In
                            </button>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-300">Don't have an account? <button type="button" id="show-register" class="text-indigo-300 hover:text-indigo-100 font-medium">Register here</button></p>
                        </div>
                    </form>

                    <form id="register-form" class="space-y-6 hidden">
                         <div>
                            <label for="reg-nrp" class="block text-sm font-medium text-gray-200 mb-1">NRP (Student ID)</label>
                            <input type="text" id="reg-nrp" required class="w-full px-4 py-2 border rounded-md focus:outline-none transition-all">
                        </div>
                        <div>
                            <label for="reg-name" class="block text-sm font-medium text-gray-200 mb-1">Full Name</label>
                            <input type="text" id="reg-name" required class="w-full px-4 py-2 border rounded-md focus:outline-none transition-all">
                        </div>
                        <div>
                            <label for="reg-password" class="block text-sm font-medium text-gray-200 mb-1">Password</label>
                            <input type="password" id="reg-password" required class="w-full px-4 py-2 border rounded-md focus:outline-none transition-all">
                        </div>
                        <div>
                            <label for="reg-confirm-password" class="block text-sm font-medium text-gray-200 mb-1">Confirm Password</label>
                            <input type="password" id="reg-confirm-password" required class="w-full px-4 py-2 border rounded-md focus:outline-none transition-all">
                        </div>
                        <div class="flex space-x-4">
                            <button type="button" id="back-to-login" class="w-1/2 bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                Back
                            </button>
                            <button type="submit" class="w-1/2 gradient-bg text-white py-2 px-4 rounded-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 btn-hover-effect">
                                Register
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Student Dashboard -->
        <div id="student-dashboard" class="hidden flex h-screen">
             <!-- Sidebar -->
              <div class="w-80 bg-slate-800 text-white flex flex-col flex-shrink-0">
                  <div class="p-6 border-b border-slate-700">
                      <div class="flex items-center">
                          <i data-feather="book-open" class="h-8 w-8 text-indigo-400"></i>
                          <span class="ml-3 text-xl font-semibold">Learning Modules</span>
                      </div>
                      <div id="student-welcome" class="text-sm text-slate-400 mt-4"></div>
                      <div id="student-clock" class="text-sm font-mono mt-2 animated-clock-text"></div>
                  </div>
                  <div class="flex-grow p-4 overflow-y-auto">
                      <div id="student-module-list" class="space-y-1"></div>
                  </div>
                  <div class="p-4 border-t border-slate-700 space-y-2 flex-shrink-0">
                      <button id="my-scores-btn" class="w-full flex items-center justify-center bg-slate-700 hover:bg-indigo-500 text-white py-2 px-4 rounded-md transition-all">
                          <i data-feather="award" class="h-5 w-5 mr-2"></i>
                          <span>My Scores</span>
                      </button>
                      <button id="change-password-btn" class="w-full flex items-center justify-center bg-slate-700 hover:bg-indigo-500 text-white py-2 px-4 rounded-md transition-all">
                          <i data-feather="key" class="h-5 w-5 mr-2"></i>
                          <span>Change Password</span>
                      </button>
                      <button id="student-logout" class="w-full flex items-center justify-center bg-slate-700 hover:bg-red-600 text-white py-2 px-4 rounded-md transition-all">
                          <i data-feather="log-out" class="h-5 w-5 mr-2"></i>
                          <span>Logout</span>
                      </button>
                  </div>
              </div>
            <!-- Main Content -->
            <div class="flex-grow p-10 overflow-y-auto bg-gray-100">
                 <div id="student-module-detail" class="bg-white p-8 rounded-lg shadow-md min-h-full"></div>
            </div>
        </div>


        <!-- Lecturer Dashboard -->
        <div id="lecturer-dashboard" class="hidden flex min-h-screen bg-slate-50">
            <!-- Sidebar -->
            <aside class="w-64 bg-white shadow-lg flex flex-col flex-shrink-0">
                <div class="p-6 border-b flex items-center justify-center">
                    <i data-feather="briefcase" class="h-8 w-8 text-indigo-600"></i>
                    <span class="ml-3 text-xl font-semibold text-gray-800">Lecturer Panel</span>
                </div>
                <div id="lecturer-clock" class="text-sm font-medium text-center px-4 py-3 border-b animated-clock-text"></div>
                <nav class="flex-grow p-4 space-y-2">
                    <a href="#" class="lecturer-sidebar-link active flex items-center px-4 py-2.5 text-sm font-medium rounded-lg" data-content="lecturer-modules-content">
                        <i data-feather="grid" class="w-5 h-5 mr-3"></i> Modules
                    </a>
                    <a href="#" class="lecturer-sidebar-link flex items-center px-4 py-2.5 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-100" data-content="lecturer-students-content">
                        <i data-feather="users" class="w-5 h-5 mr-3"></i> Students
                    </a>
                    <a href="#" class="lecturer-sidebar-link flex items-center px-4 py-2.5 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-100" data-content="lecturer-attendance-content">
                        <i data-feather="user-check" class="w-5 h-5 mr-3"></i> Attendance
                    </a>
                    <a href="#" class="lecturer-sidebar-link flex items-center px-4 py-2.5 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-100" data-content="lecturer-submissions-content">
                        <i data-feather="inbox" class="w-5 h-5 mr-3"></i> Submissions
                    </a>
                    <a href="#" class="lecturer-sidebar-link flex items-center px-4 py-2.5 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-100" data-content="lecturer-scores-content">
                        <i data-feather="award" class="w-5 h-5 mr-3"></i> Scores
                    </a>
                     <!-- NEW MENU ITEM -->
                    <a href="#" class="lecturer-sidebar-link flex items-center px-4 py-2.5 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-100" data-content="lecturer-komting-content">
                        <i data-feather="message-square" class="w-5 h-5 mr-3"></i> Hubungi Komting
                    </a>
                </nav>
                <div class="p-4 mt-auto border-t">
                     <button id="lecturer-logout" class="w-full flex items-center justify-center bg-slate-100 hover:bg-red-100 text-slate-700 hover:text-red-700 py-2.5 px-4 rounded-lg transition-all">
                         <i data-feather="log-out" class="h-5 w-5 mr-2"></i>
                         <span>Logout</span>
                    </button>
                </div>
            </aside>
            
            <!-- Main Content -->
            <main class="flex-grow p-8 overflow-y-auto">
                 <div id="lecturer-modules-content" class="lecturer-tab-content">
                     <h1 class="text-3xl font-bold text-gray-800 mb-6">Module Management</h1>
                     <div id="lecturer-modules-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                         <!-- Lecturer module cards will be rendered here -->
                     </div>
                 </div>
                 <div id="lecturer-students-content" class="lecturer-tab-content hidden">
                     <h1 class="text-3xl font-bold text-gray-800 mb-6">Registered Students</h1>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                         <div class="overflow-x-auto">
                             <table class="min-w-full divide-y divide-gray-200">
                                 <thead class="bg-gray-50">
                                     <tr>
                                         <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NRP</th>
                                         <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                         <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                     </tr>
                                 </thead>
                                 <tbody class="bg-white divide-y divide-gray-200" id="students-table-body"></tbody>
                             </table>
                         </div>
                     </div>
                 </div>
                 <div id="lecturer-attendance-content" class="lecturer-tab-content hidden">
                     <div class="flex justify-between items-center mb-6">
                         <h1 class="text-3xl font-bold text-gray-800">Student Attendance</h1>
                         <div>
                             <label for="attendance-meeting-select" class="text-sm font-medium text-gray-700 mr-2">Select Meeting:</label>
                             <select id="attendance-meeting-select" class="rounded-md border-gray-300 shadow-sm"></select>
                         </div>
                     </div>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                         <div class="overflow-x-auto">
                             <table class="min-w-full divide-y divide-gray-200">
                                 <thead class="bg-gray-50">
                                     <tr>
                                         <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NRP</th>
                                         <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                         <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                     </tr>
                                 </thead>
                                 <tbody class="bg-white divide-y divide-gray-200" id="attendance-table-body"></tbody>
                             </table>
                         </div>
                     </div>
                 </div>
                 <div id="lecturer-submissions-content" class="lecturer-tab-content hidden">
                     <div class="flex justify-between items-center mb-6">
                         <h1 class="text-3xl font-bold text-gray-800">Assignment Submissions</h1>
                         <div>
                             <label for="submission-meeting-select" class="text-sm font-medium text-gray-700 mr-2">Select Meeting:</label>
                             <select id="submission-meeting-select" class="rounded-md border-gray-300 shadow-sm"></select>
                         </div>
                     </div>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                         <div class="overflow-x-auto">
                             <table class="min-w-full divide-y divide-gray-200">
                                 <thead class="bg-gray-50">
                                     <tr>
                                         <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NRP</th>
                                         <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                         <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File</th>
                                     </tr>
                                 </thead>
                                 <tbody class="bg-white divide-y divide-gray-200" id="submission-table-body"></tbody>
                             </table>
                         </div>
                     </div>
                 </div>
                 <div id="lecturer-scores-content" class="lecturer-tab-content hidden">
                     <div class="flex justify-between items-center mb-6">
                         <h1 class="text-3xl font-bold text-gray-800">Student Scores</h1>
                         <button id="export-scores-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-all flex items-center shadow-sm">
                             <i data-feather="download" class="w-4 h-4 mr-2"></i> Export to Excel
                         </button>
                     </div>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                         <div class="overflow-x-auto">
                             <table class="min-w-full divide-y divide-gray-200">
                                 <thead class="bg-gray-50" id="scores-table-head">
                                     <!-- Header will be dynamically generated -->
                                 </thead>
                                 <tbody class="bg-white divide-y divide-gray-200" id="scores-table-body">
                                     <!-- Scores will be dynamically inserted here -->
                                 </tbody>
                             </table>
                         </div>
                     </div>
                 </div>
                 <!-- NEW CONTENT AREA -->
                 <div id="lecturer-komting-content" class="lecturer-tab-content hidden">
                     <!-- Content will be rendered by JavaScript -->
                 </div>
            </main>
        </div>

        <!-- Add/Edit Material Modal -->
        <div id="material-modal" class="modal fixed inset-0 overflow-y-auto hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="modal-backdrop"></div>
                <div class="bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:max-w-4xl sm:w-full z-50">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="material-modal-title">Edit Material</h3>
                        <form id="material-form" class="mt-4 space-y-4">
                           <input type="hidden" id="material-id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="material-meeting-number" class="block text-sm font-medium text-gray-700">Meeting Number</label>
                                    <select id="material-meeting-number" class="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md"></select>
                                </div>
                                <div>
                                    <label for="material-title" class="block text-sm font-medium text-gray-700">Title</label>
                                    <input type="text" id="material-title" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700">Content</label>
                                <div id="editor-container"></div>
                            </div>
                             <div>
                                <label for="material-file" class="block text-sm font-medium text-gray-700">Primary File Attachment (Optional)</label>
                                <input type="file" id="material-file" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                <p id="existing-file" class="text-sm text-gray-500 mt-1"></p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label for="material-audio-url" class="block text-sm font-medium text-gray-700">Audio URL (Embed)</label>
                                    <input type="url" id="material-audio-url" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="e.g., https://example.com/audio.mp3">
                                </div>
                                <div>
                                    <label for="material-video-url" class="block text-sm font-medium text-gray-700">Video URL (YouTube)</label>
                                    <input type="url" id="material-video-url" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Tempel tautan dari YouTube di sini">
                                    <p class="text-xs text-gray-500 mt-1">Akan ditampilkan sebagai thumbnail yang bisa diklik. Pastikan video tidak di-set "private".</p>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse items-center">
                        <button type="button" id="save-material" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:ml-3">Save</button>
                        <button type="button" id="cancel-material" class="mt-3 w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3">Cancel</button>
                        <button type="button" id="delete-material" class="hidden mt-3 sm:mt-0 mr-auto w-full sm:w-auto inline-flex justify-center rounded-md border border-red-300 shadow-sm px-4 py-2 bg-red-50 text-base font-medium text-red-700 hover:bg-red-100">Delete Material</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Builder Modal (Lecturer) -->
        <div id="quiz-builder-modal" class="modal fixed inset-0 overflow-y-auto hidden">
            <div class="flex items-center justify-center min-h-screen">
                <div class="modal-backdrop"></div>
                <div class="bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:max-w-3xl sm:w-full z-50">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="quiz-builder-modal-title">Create New Quiz</h3>
                        <form id="quiz-builder-form" class="mt-4 space-y-4">
                            <input type="hidden" id="quiz-id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="quiz-title" class="block text-sm font-medium text-gray-700">Quiz Title</label>
                                    <input type="text" id="quiz-title" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="quiz-meeting-number" class="block text-sm font-medium text-gray-700">Meeting Number</label>
                                    <select id="quiz-meeting-number" class="mt-1 block w-full pl-3 pr-10 py-2 border border-gray-300 rounded-md"></select>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="quiz-subtitle" class="block text-sm font-medium text-gray-700">Subtitle (Optional)</label>
                                    <input type="text" id="quiz-subtitle" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="quiz-duration" class="block text-sm font-medium text-gray-700">Durasi Kuis (menit)</label>
                                    <input type="number" id="quiz-duration" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Kosongkan jika tidak ada batas waktu">
                                </div>
                            </div>
                            <hr>
                            <div id="questions-container" class="space-y-6">
                                <!-- Questions will be added here -->
                            </div>
                        </form>
                        <div class="flex items-center space-x-4 mt-4">
                            <button type="button" id="add-question" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm flex items-center">
                                <i data-feather="plus-circle" class="mr-2"></i> Add Question
                            </button>
                             <button type="button" id="add-instruction" class="text-gray-600 hover:text-gray-800 font-medium text-sm flex items-center">
                                <i data-feather="type" class="mr-2"></i> Add Instruction
                            </button>
                            <button type="button" id="add-passage" class="text-blue-600 hover:text-blue-800 font-medium text-sm flex items-center">
                                <i data-feather="file-text" class="mr-2"></i> Add Reading Passage
                            </button>
                            <!-- Tombol baru untuk menambah media -->
                            <button type="button" id="add-media" class="text-green-600 hover:text-green-800 font-medium text-sm flex items-center">
                                <i data-feather="play-circle" class="mr-2"></i> Add Audio/Video
                            </button>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse items-center">
                        <button type="button" id="save-quiz" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:ml-3">Save Quiz</button>
                        <button type="button" id="cancel-quiz-builder" class="mt-3 w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3">Cancel</button>
                        <button type="button" id="delete-quiz" class="hidden mt-3 sm:mt-0 mr-auto w-full sm:w-auto inline-flex justify-center rounded-md border border-red-300 shadow-sm px-4 py-2 bg-red-50 text-base font-medium text-red-700 hover:bg-red-100">Delete Quiz</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Taker Modal (Student) -->
        <div id="quiz-taker-modal" class="modal fixed inset-0 overflow-y-auto hidden">
            <div class="flex items-center justify-center min-h-screen">
                <div class="modal-backdrop"></div>
                <div class="bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:max-w-2xl sm:w-full z-50">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div id="quiz-timer-display" class="hidden sticky top-0 bg-indigo-100 p-2 rounded-md mb-4 text-center">
                            <span class="text-lg font-bold text-indigo-700">Sisa Waktu: <span id="quiz-timer"></span></span>
                        </div>
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="quiz-taker-modal-title">Quiz Title</h3>
                        <p class="text-sm text-gray-500 mt-1" id="quiz-taker-modal-subtitle"></p>
                        <div id="quiz-taker-content" class="mt-4">
                            <!-- Quiz form or result will be shown here -->
                        </div>
                    </div>
                    <div id="quiz-taker-footer" class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="button" id="submit-quiz-answers" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:ml-3 sm:w-auto sm:text-sm">Submit</button>
                        <button type="button" id="close-quiz-taker" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Change Password Modal (Student) -->
        <div id="change-password-modal" class="modal fixed inset-0 overflow-y-auto hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="modal-backdrop"></div>
                <div class="bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:max-w-md sm:w-full z-50">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Change Your Password</h3>
                        <form id="change-password-form" class="mt-4 space-y-4">
                            <div>
                                <label for="old-password" class="block text-sm font-medium text-gray-700">Old Password</label>
                                <input type="password" id="old-password" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                             <div>
                                <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                                <input type="password" id="new-password" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                             <div>
                                <label for="confirm-new-password" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                                <input type="password" id="confirm-new-password" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                        </form>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse items-center">
                        <button type="button" id="save-new-password" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:ml-3">Save Changes</button>
                        <button type="button" id="cancel-change-password" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmation-modal" class="modal fixed inset-0 overflow-y-auto hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="modal-backdrop"></div>
                <div class="bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full z-50">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                                <i data-feather="alert-triangle" class="h-6 w-6 text-red-600"></i>
                            </div>
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="confirmation-modal-title">Confirmation</h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-500" id="confirmation-modal-message">Are you sure you want to proceed? This action cannot be undone.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="button" id="confirm-action-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">
                            Confirm
                        </button>
                        <button type="button" id="cancel-action-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
<div id="essay-viewer-modal" class="modal fixed inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-backdrop"></div>
            <div class="bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:max-w-2xl sm:w-full z-50">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="essay-viewer-title">Student Essay</h3>
                    <p class="text-sm text-gray-500 mb-4" id="essay-viewer-student"></p>
                    <div class="prose max-w-none bg-gray-50 p-4 rounded-md border min-h-[300px] max-h-[60vh] overflow-y-auto" id="essay-viewer-content">
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="close-essay-viewer-btn" class="mt-3 w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3">Close</button>
                </div>
            </div>
        </div>
    </div>
    </div>
    
    <div id="notification"></div>

    <script>
        AOS.init();
        feather.replace();

        // --- KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://fxuvhqdfwtefyobfkeuy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4dXZocWRmd3RlZnlvYmZrZXV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0MTc4OTcsImV4cCI6MjA3Mzk5Mzg5N30.YKXDn0xMaL3ZFt5qGKTFJvxY1pY_4bs8RbMPXil0juo';
        
        const { createClient } = window.supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Static RPS Data
        const rpsData = [
            { week: 1, topic: "Introduction & Diagnostic Test", description: "Introduction, syllabus, and simple placement test." },
            { week: 2, topic: "Daily Routines & Simple Present Tense", description: "Vocabulary for campus activities and transportation professions." },
            { week: 3, topic: "Talking about Past Events: Simple Past Tense", description: "Telling experiences using transportation." },
            { week: 4, topic: "Reading Skills 1: Skimming", description: "Understanding short descriptive texts about professions." },
            { week: 5, topic: "Writing 1: Structuring a Paragraph", description: "Writing a topic sentence and a simple paragraph." },
            { week: 6, topic: "Giving Simple Instructions & Imperatives", description: "Language for giving directions and safety procedures." },
            { week: 7, topic: "Listening Skills: Announcements", description: "Listening to announcements at airports and stations." },
            { week: 8, topic: "MIDTERM EXAM (UTS)", description: "Written test covering multiple choice and fill-in-the-blank questions." },
            { week: 9, topic: "Future Plans & Simple Future Tense", description: "Discussing travel plans and future transportation technology." },
            { week: 10, topic: "Reading Skills 2: Scanning", description: "Reading articles for specific information." },
            { week: 11, topic: "Writing 2: Descriptive Paragraph", description: "Writing a descriptive paragraph about a transportation place." },
            { week: 12, topic: "Speaking & Presentation 1", description: "Presenting the descriptive paragraph in front of the class." },
            { week: 13, topic: "Comparing & Contrasting", description: "Comparing various modes of transportation." },
            { week: 14, topic: "Integrated Skills: Case Study", description: "Planning a trip (case study)." },
            { week: 15, topic: "Review & Reflection", description: "Reviewing all materials and reflection." },
            { week: 16, topic: "FINAL EXAM (UAS)", description: "Comprehensive test covering multiple choice and fill-in-the-blank questions." }
        ];

        // NEW: Static Komting Data (Class Captains) - Now mutable
        let komtingData = [
            { prodi: 'Teknik Transportasi Laut', nama: 'Budi Santoso', wa: '6281234567890' },
            { prodi: 'Teknika', nama: 'Citra Lestari', wa: '6281234567891' },
            { prodi: 'Nautika', nama: 'Adi Nugroho', wa: '6281234567892' },
            { prodi: 'Ketatalaksanaan Pelayaran Niaga dan Kepelabuhanan (KPN)', nama: 'Dewi Anggraini', wa: '6281234567893' }
        ];

        // Global variable for Quill editor instance
        let quill = null;
        let quizQuillEditors = {};
        let dynamicRpsData = []; // Ini akan menggantikan rpsData yang statis
        let fullStudentData = {}; // Cache for student view data
        let currentlyViewedMeeting = null; // To track the active module
        let quizTimerInterval = null;
        let isKomtingEditMode = false; // To track komting edit state

        async function fetchRpsData() {
    const { data, error } = await db.from('rps').select('*').order('week');
    if (error) {
        console.error("Error fetching RPS data:", error);
        showNotification("Error loading RPS data. Please refresh.", "error");
    } else {
        dynamicRpsData = data; // Ini akan mengisi variabel global
    }
}
        // --- UTILITY & PAGE VISIBILITY FUNCTIONS ---
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            clearTimeout(notification.timeoutId);
            notification.textContent = message;
            notification.className = '';
            notification.classList.add(type, 'show');
            notification.timeoutId = setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function showConfirmationModal(title, message, onConfirm) {
            const confirmationModal = document.getElementById('confirmation-modal');
            document.getElementById('confirmation-modal-title').textContent = title;
            document.getElementById('confirmation-modal-message').textContent = message;
            
            const confirmBtn = document.getElementById('confirm-action-btn');
            
            // Clone and replace the button to remove old event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.addEventListener('click', () => {
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
                confirmationModal.classList.add('hidden');
            });
            
            confirmationModal.classList.remove('hidden');
            feather.replace(); // Re-render the icon in the modal
        }

        function getYoutubeVideoId(url) {
            if (!url || typeof url !== 'string') return null;

            let videoId = null;
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(youtubeRegex);

            if (match && match[1]) {
                videoId = match[1];
            }
            return videoId;
        }

        // Helper function to detect media type
        function getMediaType(url) {
             if (!url) return null;
             if (getYoutubeVideoId(url)) return 'youtube';
             if (url.match(/\.(mp3|wav|ogg|aac)$/i)) return 'audio';
             if (url.match(/\.(mp4|webm|ogv)$/i)) return 'video';
             return 'unknown'; // Or handle other types if needed
        }


        function populateMeetingOptions(selectElementId) {
            const select = document.getElementById(selectElementId);
            if (!select) return;
            select.innerHTML = '';
            dynamicRpsData.forEach(item => {
                 const option = new Option(`Meeting ${item.week}: ${item.topic}`, item.week);
                 select.add(option);
            });
        }
        
        function showLoginPage(show) {
            const loginPage = document.getElementById('login-page');
            if (show) {
                loginPage.classList.remove('hidden');
            } else {
                loginPage.classList.add('hidden');
            }
        }
        
        async function showStudentDashboard(show) {
            const studentDashboard = document.getElementById('student-dashboard');
            const user = JSON.parse(sessionStorage.getItem('user'));
            if (show && user && user.role === 'student') {
                studentDashboard.classList.remove('hidden');
                document.getElementById('student-welcome').textContent = `Welcome, ${user.name}!`;
                await renderStudentUnifiedView();
            } else {
                studentDashboard.classList.add('hidden');
            }
        }
        
       async function showLecturerDashboard(show) {
    const lecturerDashboard = document.getElementById('lecturer-dashboard');
    const user = JSON.parse(sessionStorage.getItem('user'));
    
    if (show && user && user.role === 'lecturer') {
        lecturerDashboard.classList.remove('hidden');

        // DIPINDAHKAN KE SINI: Isi dropdown SEBELUM merender modul
        populateMeetingOptions('quiz-meeting-number');
        populateMeetingOptions('material-meeting-number');
        populateMeetingOptions('attendance-meeting-select');
        populateMeetingOptions('submission-meeting-select');

        await renderLecturerModules();
        feather.replace();
    } else {
        lecturerDashboard.classList.add('hidden');
        // KOSONGKAN BLOK INI
    }
}

        function updateClock() {
            const studentClock = document.getElementById('student-clock');
            const lecturerClock = document.getElementById('lecturer-clock');
            
            if (!studentClock && !lecturerClock) return;

            const now = new Date();
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

            const dayName = days[now.getDay()];
            const date = now.getDate();
            const monthName = months[now.getMonth()];
            const year = now.getFullYear();
            
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            const formattedTime = `${dayName}, ${date} ${monthName} ${year}, ${hours}:${minutes}:${seconds} WIB`;

            if (studentClock && !document.getElementById('student-dashboard').classList.contains('hidden')) {
                studentClock.innerHTML = formattedTime;
            }
            if (lecturerClock && !document.getElementById('lecturer-dashboard').classList.contains('hidden')) {
                lecturerClock.innerHTML = formattedTime;
            }
        }

        // --- AUTH & NAVIGATION FUNCTIONS ---
        function logout() {
            sessionStorage.removeItem('user');
            db.auth.signOut();
            showStudentDashboard(false);
            showLecturerDashboard(false);
            showLoginPage(true);
        }
        
        // --- MATERIAL MANAGEMENT ---
        function initializeQuillEditor() {
            if (quill) return;
            const toolbarOptions = [
                [{ 'font': [] }],
                [{ 'size': ['small', false, 'large', 'huge'] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['link', 'image', 'video'],
                ['clean']
            ];
            quill = new Quill('#editor-container', {
                modules: { toolbar: toolbarOptions },
                theme: 'snow'
            });
            quill.getModule('toolbar').addHandler('image', selectLocalImage);
        }
        
        function selectLocalImage() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();

            input.onchange = async () => {
                const file = input.files[0];
                if (/^image\//.test(file.type)) {
                    const filePath = `public/materials/${Date.now()}-${file.name}`;
                    const { error: uploadError } = await db.storage.from('materials').upload(filePath, file);
                    if (uploadError) {
                        showNotification('Image upload failed: ' + uploadError.message, 'error');
                        return;
                    }
                    const { data: urlData } = db.storage.from('materials').getPublicUrl(filePath);
                    const range = quill.getSelection(true);
                    quill.insertEmbed(range.index, 'image', urlData.publicUrl);
                } else {
                    showNotification('Only images are allowed', 'error');
                }
            };
        }

        function selectLocalImageForQuiz(editorInstance) {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();

            input.onchange = async () => {
                const file = input.files[0];
                if (/^image\//.test(file.type)) {
                    const filePath = `public/quiz-images/${Date.now()}-${file.name}`;
                    const { error: uploadError } = await db.storage.from('materials').upload(filePath, file);
                    if (uploadError) {
                        showNotification('Image upload failed: ' + uploadError.message, 'error');
                        return;
                    }
                    const { data: urlData } = db.storage.from('materials').getPublicUrl(filePath);
                    const range = editorInstance.getSelection(true);
                    editorInstance.insertEmbed(range.index, 'image', urlData.publicUrl);
                } else {
                    showNotification('Only images are allowed', 'error');
                }
            };
        }

        function openMaterialModal(material = null, meetingNumber = null) {
            const materialModal = document.getElementById('material-modal');
            const materialForm = document.getElementById('material-form');
            initializeQuillEditor();
            materialForm.reset();
            quill.root.innerHTML = '';
            
            const modalTitle = document.getElementById('material-modal-title');
            const materialIdInput = document.getElementById('material-id');
            const existingFileP = document.getElementById('existing-file');
            const meetingSelect = document.getElementById('material-meeting-number');
            const deleteMaterialBtn = document.getElementById('delete-material');

            if (material) {
                modalTitle.textContent = `Edit Material for Meeting ${material.meeting}`;
                materialIdInput.value = material.id;
                meetingSelect.value = material.meeting;
                document.getElementById('material-title').value = material.title;
                quill.root.innerHTML = material.content || '';
                existingFileP.textContent = `Current file: ${material.file_name || 'None'}`;
                document.getElementById('material-audio-url').value = material.audio_url || '';
                document.getElementById('material-video-url').value = material.video_url || '';
                meetingSelect.disabled = true;
                deleteMaterialBtn.classList.remove('hidden');
                deleteMaterialBtn.onclick = () => deleteMaterial(material.id);
            } else {
                modalTitle.textContent = `Add Material for Meeting ${meetingNumber}`;
                materialIdInput.value = '';
                existingFileP.textContent = '';
                meetingSelect.value = meetingNumber;
                meetingSelect.disabled = true;
                deleteMaterialBtn.classList.add('hidden');
            }
            materialModal.classList.remove('hidden');
        }
        
        async function saveMaterial() {
            const id = document.getElementById('material-id').value;
            const meeting = document.getElementById('material-meeting-number').value;
            const title = document.getElementById('material-title').value;
            const content = quill.root.innerHTML;
            const fileInput = document.getElementById('material-file');
            const audio_url = document.getElementById('material-audio-url').value;
            const video_url = document.getElementById('material-video-url').value;
            const file = fileInput.files[0];

            if (!title || quill.getLength() <= 1) {
                showNotification('Title and content are required', 'error');
                return;
            }

            let file_url = null;
            let file_name = null;
            
            if (file) {
                const filePath = `public/materials/${Date.now()}-${file.name}`;
                const { error: uploadError } = await db.storage.from('materials').upload(filePath, file);
                if (uploadError) {
                    showNotification('File upload failed: ' + uploadError.message, 'error');
                    return;
                }
                const { data: urlData } = db.storage.from('materials').getPublicUrl(filePath);
                file_url = urlData.publicUrl;
                file_name = file.name;
            }

            const materialData = { meeting, title, content, audio_url, video_url };
            if (file_url) {
                materialData.file_url = file_url;
                materialData.file_name = file_name;
            }

            const { error } = await db.from('materials').upsert({ id: id || undefined, ...materialData });

            if (error) {
                showNotification('Failed to save material: ' + error.message, 'error');
            } else {
                showNotification('Material saved successfully!');
                document.getElementById('material-modal').classList.add('hidden');
                await renderLecturerModules();
            }
        }
        
        async function deleteMaterial(materialId) {
            if (confirm('Are you sure you want to delete this material?')) {
                const { error } = await db.from('materials').delete().eq('id', materialId);
                if (error) {
                    showNotification('Failed to delete material: ' + error.message, 'error');
                } else {
                    showNotification('Material deleted.');
                    document.getElementById('material-modal').classList.add('hidden');
                    await renderLecturerModules();
                }
            }
        }

        // --- QUIZ BUILDER (LECTURER) ---

        async function openQuizBuilderModal(quiz = null, meetingNumber = null) {
            const quizBuilderModal = document.getElementById('quiz-builder-modal');
            const questionsContainer = document.getElementById('questions-container');
            document.getElementById('quiz-builder-form').reset();
            questionsContainer.innerHTML = '';
            quizQuillEditors = {}; // Reset the editors object
            document.getElementById('quiz-id').value = '';
            const meetingSelect = document.getElementById('quiz-meeting-number');
            const deleteQuizBtn = document.getElementById('delete-quiz');

            const title = document.getElementById('quiz-builder-modal-title');
            if (quiz) {
                title.textContent = 'Edit Quiz';
                document.getElementById('quiz-id').value = quiz.id;
                document.getElementById('quiz-title').value = quiz.title;
                document.getElementById('quiz-subtitle').value = quiz.subtitle || '';
                document.getElementById('quiz-duration').value = quiz.duration_minutes || '';
                meetingSelect.value = quiz.meeting;
                meetingSelect.disabled = true;
                deleteQuizBtn.classList.remove('hidden');
                deleteQuizBtn.onclick = () => deleteQuiz(quiz.id);
                
                const { data: questions } = await db.from('questions').select('*').eq('quiz_id', quiz.id).order('display_order');
                if (questions && questions.length > 0) {
                    questions.forEach(q => {
                         if (q.question_type === 'instructional_text') {
                            addInstructionField(q);
                        } else if (q.question_type === 'reading_passage') {
                            addPassageField(q);
                        } else if (q.question_type === 'media_embed') {
                            addMediaField(q);
                        } else {
                            addQuestionField(q);
                        }
                    });
                } else {
                    addQuestionField(); // Start with one question if none exist
                }
            } else {
                title.textContent = 'Create New Quiz';
                addQuestionField(); // Start with one question
                meetingSelect.value = meetingNumber;
                meetingSelect.disabled = true;
                deleteQuizBtn.classList.add('hidden');
            }
            
            new Sortable(questionsContainer, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
            });

            quizBuilderModal.classList.remove('hidden');
            feather.replace();
        }

        function addInstructionField(data = null) {
            const questionsContainer = document.getElementById('questions-container');
            const div = document.createElement('div');
            div.className = 'border-l-4 border-blue-500 bg-blue-50 p-4 rounded-md relative';
            div.dataset.type = 'instruction';
            
            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center">
                        <i data-feather="move" class="drag-handle mr-2 text-gray-400"></i>
                        <label class="block text-sm font-medium text-blue-800">Instruction Text</label>
                    </div>
                    <button type="button" class="text-red-500 hover:text-red-700 remove-item-btn"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                </div>
                <input type="hidden" class="item-id" value="${data?.id || ''}">
                <textarea class="instruction-text mt-1 w-full p-2 border rounded-md" required placeholder="Enter instruction text...">${data?.question_text || ''}</textarea>
            `;
            questionsContainer.appendChild(div);
            div.querySelector('.remove-item-btn').addEventListener('click', () => div.remove());
            feather.replace();
        }

        function addPassageField(data = null) {
            const questionsContainer = document.getElementById('questions-container');
            const div = document.createElement('div');
            div.className = 'border-l-4 border-gray-500 bg-gray-50 p-4 rounded-md relative';
            div.dataset.type = 'passage';
            
            const editorId = `passage-editor-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center">
                        <i data-feather="move" class="drag-handle mr-2 text-gray-400"></i>
                        <label class="block text-sm font-medium text-gray-800">Reading Passage</label>
                    </div>
                    <button type="button" class="text-red-500 hover:text-red-700 remove-item-btn"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                </div>
                <input type="hidden" class="item-id" value="${data?.id || ''}">
                <div id="${editorId}" class="passage-editor bg-white"></div>
            `;
            questionsContainer.appendChild(div);

            const passageQuill = new Quill(`#${editorId}`, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        ['clean']
                    ]
                }
            });

            // Add custom image handler to upload to Supabase
            passageQuill.getModule('toolbar').addHandler('image', () => {
                 selectLocalImageForQuiz(passageQuill);
            });
            
            quizQuillEditors[editorId] = passageQuill;

            if (data && data.question_text) {
                passageQuill.root.innerHTML = data.question_text;
            }

            // Set a default height for the editor
            document.querySelector(`#${editorId} .ql-editor`).style.minHeight = '150px';


            div.querySelector('.remove-item-btn').addEventListener('click', () => {
                delete quizQuillEditors[editorId];
                div.remove();
            });
            feather.replace();
        }

        // Fungsi untuk menambah field media
        function addMediaField(data = null) {
            const questionsContainer = document.getElementById('questions-container');
            const div = document.createElement('div');
            div.className = 'border-l-4 border-green-500 bg-green-50 p-4 rounded-md relative';
            div.dataset.type = 'media';

            // Determine initial values based on question_text
            let existingMediaUrl = '';
            let existingMediaType = '';
            if (data && data.question_text) {
                existingMediaUrl = data.question_text;
                existingMediaType = getMediaType(data.question_text);
            }

            let existingMediaPreview = '';
            if (existingMediaUrl) {
                if (existingMediaType === 'audio') {
                    existingMediaPreview = `<div class="mt-2 p-2 bg-white rounded"><p class="text-xs text-gray-600 mb-1">Current audio:</p><audio controls class="w-full" src="${existingMediaUrl}"></audio></div>`;
                } else if (existingMediaType === 'video') {
                    existingMediaPreview = `<div class="mt-2 p-2 bg-white rounded"><p class="text-xs text-gray-600 mb-1">Current video:</p><video controls class="w-full h-40" src="${existingMediaUrl}"></video></div>`;
                } else if (existingMediaType === 'youtube') {
                    const videoId = getYoutubeVideoId(existingMediaUrl);
                    existingMediaPreview = `<div class="mt-2 p-2 bg-white rounded"><p class="text-xs text-gray-600 mb-1">Current YouTube:</p><iframe width="100%" height="160" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe></div>`;
                }
            }

            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center">
                        <i data-feather="move" class="drag-handle mr-2 text-gray-400"></i>
                        <label class="block text-sm font-medium text-green-800">Audio/Video Upload</label>
                    </div>
                    <button type="button" class="text-red-500 hover:text-red-700 remove-item-btn"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                </div>
                <input type="hidden" class="item-id" value="${data?.id || ''}">
                <input type="hidden" class="existing-media-url" value="${existingMediaUrl}">
                ${existingMediaPreview}
                <div class="space-y-3 mt-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Upload Audio File (MP3, WAV, OGG)</label>
                        <input type="file" class="media-audio-file w-full p-2 border rounded-md text-sm" accept="audio/*">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Upload Video File (MP4, WEBM)</label>
                        <input type="file" class="media-video-file w-full p-2 border rounded-md text-sm" accept="video/*">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Or YouTube URL</label>
                        <input type="url" class="media-youtube-url w-full p-2 border rounded-md text-sm" placeholder="https://youtube.com/watch?v=...">
                    </div>
                </div>
            `;
            questionsContainer.appendChild(div);
            div.querySelector('.remove-item-btn').addEventListener('click', () => div.remove());
            feather.replace();
        }

        function addQuestionField(questionData = null) {
            const questionsContainer = document.getElementById('questions-container');
            const questionIndex = questionsContainer.querySelectorAll('[data-type="question"]').length;
            const div = document.createElement('div');
            div.className = 'border p-4 rounded-md relative';
            div.dataset.type = 'question';
            const questionType = (questionData?.question_type === 'multiple_choice' || questionData?.question_type === 'fill_in_the_blank')
                                 ? questionData.question_type
                                 : 'multiple_choice'; // Default jika tipe tidak valid atau null


            let imagePreviewHTML = '';
            if (questionData && questionData.image_url) {
                imagePreviewHTML = `
                    <div class="relative w-32 h-20">
                        <img src="${questionData.image_url}" class="w-full h-full object-cover rounded-md">
                        <input type="hidden" class="current-image-url" value="${questionData.image_url}">
                        <button type="button" class="absolute top-0 right-0 -mt-2 -mr-2 bg-red-500 text-white rounded-full p-1 remove-image-btn">
                            <i data-feather="x" class="w-3 h-3"></i>
                        </button>
                    </div>
                `;
            }

            // Memberi ID unik pada name radio button tipe pertanyaan
            const uniqueRadioName = `q-type-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;


            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center">
                        <i data-feather="move" class="drag-handle mr-2 text-gray-400"></i>
                        <label class="block text-sm font-medium text-gray-700">Question ${questionIndex + 1}</label>
                    </div>
                    <div class="flex items-center space-x-4">
                         <label class="text-sm"><input type="radio" name="${uniqueRadioName}" value="multiple_choice" class="question-type-selector" ${questionType === 'multiple_choice' ? 'checked' : ''}> Multiple Choice</label>
                         <label class="text-sm"><input type="radio" name="${uniqueRadioName}" value="fill_in_the_blank" class="question-type-selector" ${questionType === 'fill_in_the_blank' ? 'checked' : ''}> Fill in the Blank</label>
                         <button type="button" class="text-red-500 hover:text-red-700 remove-item-btn"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <input type="hidden" class="item-id" value="${questionData?.id || ''}">
                <textarea class="question-text mt-1 w-full p-2 border rounded-md" required placeholder="Enter the question text...">${questionData?.question_text || ''}</textarea>
                
                <div class="mt-2">
                    <label class="block text-xs font-medium text-gray-600">Image (Optional)</label>
                    <div class="image-preview-container mt-1 mb-2">${imagePreviewHTML}</div>
                    <input type="file" class="question-image-input text-sm text-gray-500 file:mr-4 file:py-1 file:px-2 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" accept="image/*">
                </div>

                <div class="options-container mt-2 space-y-2 ${questionType === 'multiple_choice' ? '' : 'hidden'}">
                    ${[0, 1, 2, 3].map(i => `
                        <div class="flex items-center">
                            <input type="radio" name="correct-opt-${uniqueRadioName}" value="${i}" class="correct-option h-4 w-4 text-indigo-600" ${questionData?.correct_option === i ? 'checked' : ''}>
                            <input type="text" placeholder="Option ${i + 1}" value="${questionData?.options?.[i] || ''}" class="option-text ml-2 w-full p-2 border rounded-md">
                        </div>
                    `).join('')}
                </div>
                <div class="answer-container mt-2 ${questionType === 'fill_in_the_blank' ? '' : 'hidden'}">
                    <input type="text" placeholder="Enter correct answer" value="${questionData?.correct_answer_text || ''}" class="correct-answer-text w-full p-2 border rounded-md">
                </div>
            `;
            questionsContainer.appendChild(div);
            
            div.querySelector('.remove-item-btn').addEventListener('click', () => div.remove());
            
            const removeImageBtn = div.querySelector('.remove-image-btn');
            if (removeImageBtn) {
                removeImageBtn.addEventListener('click', (e) => {
                    e.currentTarget.parentElement.remove();
                });
            }

            div.querySelectorAll('.question-type-selector').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isMc = e.target.value === 'multiple_choice';
                    div.querySelector('.options-container').classList.toggle('hidden', !isMc);
                    div.querySelector('.answer-container').classList.toggle('hidden', isMc);
                });
            });
            feather.replace();
        }

        async function saveQuiz() {
            console.log("[SaveQuiz Debug] Starting saveQuiz function..."); // Log awal fungsi
            const quizId = document.getElementById('quiz-id').value;
            const title = document.getElementById('quiz-title').value;
            const subtitle = document.getElementById('quiz-subtitle').value;
            const meeting = document.getElementById('quiz-meeting-number').value;
            const durationInput = document.getElementById('quiz-duration').value;
            const duration_minutes = durationInput ? parseInt(durationInput, 10) : null;

            if (!title) {
                showNotification('Quiz title is required', 'error');
                return;
            }

            try {
                // 1. Upsert the quiz details first to get a valid quiz ID.
                let quizDetails = { id: quizId || undefined, title, subtitle, meeting, duration_minutes };
                console.log("[SaveQuiz Debug] Upserting quiz details:", quizDetails);
                let { data: quizData, error: quizError } = await db.from('quizzes').upsert(quizDetails).select().single();

                if (quizError && quizError.message.includes('duration_minutes')) {
                    console.warn("[SaveQuiz Debug] Column 'duration_minutes' not found. Retrying without it.");
                    showNotification("Fitur timer belum aktif di database. Kuis disimpan tanpa timer.", 'error');
                    delete quizDetails.duration_minutes;
                    const retryResult = await db.from('quizzes').upsert(quizDetails).select().single();
                    quizData = retryResult.data;
                    quizError = retryResult.error;
                }

                if (quizError) throw quizError;
                 console.log("[SaveQuiz Debug] Quiz details saved/updated. Quiz ID:", quizData.id);


                const currentQuizId = quizData.id;
                const itemElements = Array.from(document.getElementById('questions-container').children);
                console.log(`[SaveQuiz Debug] Found ${itemElements.length} items in the container.`);
                let validationError = false;

                // 2. Build a list of payloads for all items in the form.
                const preUploadPayloads = await Promise.all(itemElements.map(async (el, index) => {
                    console.log(`[SaveQuiz Debug] Processing item at index ${index}...`);
                    if (validationError) return null;

                    const idValue = el.querySelector('.item-id')?.value;
                    const parsedId = idValue ? parseInt(idValue, 10) : NaN;
                    const type = el.dataset.type;
                     console.log(`  [Debug Index ${index}] ID: ${idValue}, Parsed ID: ${parsedId}, Type: ${type}`);
                    
                    // --- Payload default ---
                    let payload = {
                        id: !isNaN(parsedId) ? parsedId : undefined,
                        quiz_id: currentQuizId,
                        display_order: index,
                        question_text: '',
                        question_type: '',
                        options: null,
                        correct_option: null,
                        correct_answer_text: null,
                        image_url: null,
                    };

                    if (type === 'instruction') {
                        payload.question_type = 'instructional_text';
                        payload.question_text = el.querySelector('.instruction-text')?.value;
                        if (!payload.question_text) {
                            showNotification(`Instruction text cannot be empty at index ${index}.`, 'error');
                            validationError = true;
                        }
                    } else if (type === 'passage') {
                        payload.question_type = 'reading_passage';
                        const editorDiv = el.querySelector('.passage-editor');
                        if (editorDiv && quizQuillEditors[editorDiv.id]) {
                            const quillInstance = quizQuillEditors[editorDiv.id];
                            payload.question_text = quillInstance.root.innerHTML;
                            if (quillInstance.getLength() <= 1) {
                                showNotification(`Reading passage text cannot be empty at index ${index}.`, 'error');
                                validationError = true;
                            }
                        } else {
                            showNotification(`Editor for passage not found at index ${index}.`, 'error');
                            validationError = true;
                        }
                    // --- Upload dan simpan file media ke question_text ---
                    } else if (type === 'media') {
                        payload.question_type = 'media_embed';
                        const audioFile = el.querySelector('.media-audio-file')?.files[0];
                        const videoFile = el.querySelector('.media-video-file')?.files[0];
                        const youtubeUrl = el.querySelector('.media-youtube-url')?.value || null;
                        const existingMediaUrl = el.querySelector('.existing-media-url')?.value || null;
                        
                        let mediaUrl = existingMediaUrl;
                        
                        // Upload audio file jika ada
                        if (audioFile) {
                            const audioPath = `public/quiz-media/${Date.now()}-${audioFile.name}`;
                            const { error: uploadError } = await db.storage.from('materials').upload(audioPath, audioFile);
                            if (uploadError) {
                                showNotification(`Audio upload failed at index ${index}: ` + uploadError.message, 'error');
                                validationError = true;
                            } else {
                                const { data: urlData } = db.storage.from('materials').getPublicUrl(audioPath);
                                mediaUrl = urlData.publicUrl;
                            }
                        }
                        // Upload video file jika ada
                        else if (videoFile) {
                            const videoPath = `public/quiz-media/${Date.now()}-${videoFile.name}`;
                            const { error: uploadError } = await db.storage.from('materials').upload(videoPath, videoFile);
                            if (uploadError) {
                                showNotification(`Video upload failed at index ${index}: ` + uploadError.message, 'error');
                                validationError = true;
                            } else {
                                const { data: urlData } = db.storage.from('materials').getPublicUrl(videoPath);
                                mediaUrl = urlData.publicUrl;
                            }
                        }
                        // Gunakan YouTube URL jika ada
                        else if (youtubeUrl) {
                            mediaUrl = youtubeUrl;
                        }
                        
                        payload.question_text = mediaUrl;

// Cek ini HANYA jika tidak ada error upload sebelumnya DAN mediaUrl masih kosong
if (!validationError && !payload.question_text) { 
    showNotification(`Please upload a media file or provide YouTube URL at index ${index}.`, 'error');
    validationError = true;
}
                    } else if (type === 'question') {
                        payload.question_text = el.querySelector('.question-text')?.value;
                        payload.question_type = el.querySelector('.question-type-selector:checked').value;
                         console.log(`  [Debug Index ${index}] Question Type selected: ${payload.question_type}`);

                        if (payload.question_type === 'multiple_choice') {
                             // --- Pastikan selector scoped ke elemen 'el' ---
                            const correctOptionInput = el.querySelector('.correct-option:checked');
                            const correctOptionValue = correctOptionInput?.value;
                            payload.options = Array.from(el.querySelectorAll('.option-text')).map(input => input.value);
                             // --- LOGGING TAMBAHAN SPESIFIK UNTUK INDEX 16 ---
                            if (index === 16) {
                                console.log(`  [MC Specific Debug - Index 16] Raw correctOptionInput element:`, correctOptionInput);
                                console.log(`  [MC Specific Debug - Index 16] Raw correctOptionValue from element:`, correctOptionValue);
                                console.log(`  [MC Specific Debug - Index 16] Raw options elements:`, el.querySelectorAll('.option-text'));
                                console.log(`  [MC Specific Debug - Index 16] Options values mapped:`, payload.options);
                            }

                            console.log(`  [MC Debug - Index ${index}] Options found:`, payload.options);
                            console.log(`  [MC Debug - Index ${index}] Correct option input checked: `, correctOptionInput);
                            console.log(`  [MC Debug - Index ${index}] Correct option value from input: ${correctOptionValue}`);

                            if (!payload.question_text || correctOptionValue === undefined || payload.options.some(opt => !opt)) {
                                showNotification(`Please fill all fields for multiple choice question #${index + 1} (Internal Index: ${index})`, 'error');
                                console.error(`Validation failed for MC question at index ${index}: text=${payload.question_text}, correctOption=${correctOptionValue}, options=${JSON.stringify(payload.options)}`);
                                validationError = true;
                            }
                            payload.correct_option = correctOptionValue !== undefined ? parseInt(correctOptionValue, 10) : null;
                             console.log(`  [MC Debug - Index ${index}] Payload correct_option set to: ${payload.correct_option}`);

                        } else { // fill_in_the_blank
                            payload.correct_answer_text = el.querySelector('.correct-answer-text').value;
                            if (!payload.question_text || !payload.correct_answer_text) {
                                showNotification(`Please fill all fields for fill in the blank question #${index + 1}`, 'error');
                                validationError = true;
                            }
                        }
                        
                        const fileToUpload = el.querySelector('.question-image-input')?.files[0];
                        const existingImageUrl = el.querySelector('.current-image-url')?.value;
                        
                        if (fileToUpload) {
                            const filePath = `public/quiz-images/${currentQuizId}/${Date.now()}-${fileToUpload.name}`;
                            const { data, error } = await db.storage.from('materials').upload(filePath, fileToUpload);
                            if (error) throw error;
                            const { data: urlData } = db.storage.from('materials').getPublicUrl(data.path);
                            payload.image_url = urlData.publicUrl;
                        } else if (existingImageUrl) {
                            payload.image_url = existingImageUrl;
                        }
                    }
                    // --- Log payload sebelum return ---
                    console.log(`[SaveQuiz Debug] Payload for index ${index} (type: ${type}):`, JSON.parse(JSON.stringify(payload)));
                    return payload;
                }));


                if (validationError) {
                     console.error("[SaveQuiz Debug] Validation failed. Aborting save.");
                     return;
                }

                const finalPayloads = preUploadPayloads.filter(p => p !== null);
                console.log("[SaveQuiz Debug] Final payloads to be processed:", finalPayloads);

                
                // 3. Separate payloads for items that need to be inserted vs. updated.
                const itemsToInsert = finalPayloads.filter(p => p.id === undefined).map(({ id, ...rest }) => rest);
                const itemsToUpdate = finalPayloads.filter(p => p.id !== undefined);

                 console.log("[SaveQuiz Debug] Items to insert:", itemsToInsert);
                 console.log("[SaveQuiz Debug] Items to update:", itemsToUpdate);


                // 4. Perform inserts and updates.
                const insertPromise = itemsToInsert.length > 0 ? db.from('questions').insert(itemsToInsert).select('id') : Promise.resolve({ data: [], error: null });
                const updatePromise = itemsToUpdate.length > 0 ? db.from('questions').upsert(itemsToUpdate).select('id') : Promise.resolve({ data: [], error: null });

                const [insertResult, updateResult] = await Promise.all([insertPromise, updatePromise]);

                if (insertResult.error) {
                    console.error("[SaveQuiz Debug] Insert error:", insertResult.error);
                    throw insertResult.error;
                }
                 if (updateResult.error) {
                    console.error("[SaveQuiz Debug] Update error:", updateResult.error);
                    throw updateResult.error;
                }
                 console.log("[SaveQuiz Debug] Insert result:", insertResult.data);
                 console.log("[SaveQuiz Debug] Update result:", updateResult.data);


                // 5. Build a list of all item IDs that should be in the database.
                const insertedIds = insertResult.data ? insertResult.data.map(d => d.id) : [];
                const updatedIds = updateResult.data ? updateResult.data.map(d => d.id) : [];
                const finalIds = [...insertedIds, ...updatedIds];
                 console.log("[SaveQuiz Debug] Final IDs in DB for this quiz:", finalIds);

                
                // 6. Delete any items from the database that are no longer in the form.
                if (quizId) { // Only run deletion for existing quizzes
                    const { data: existingItems, error: fetchError } = await db.from('questions').select('id').eq('quiz_id', currentQuizId);
                    if (fetchError) throw fetchError;

                    const existingItemIds = existingItems ? existingItems.map(q => q.id) : [];
                    const idsToDelete = existingItemIds.filter(id => !finalIds.includes(id));
                     console.log("[SaveQuiz Debug] Existing item IDs:", existingItemIds);
                     console.log("[SaveQuiz Debug] IDs to delete:", idsToDelete);

                    
                    if (idsToDelete.length > 0) {
                        const { error: deleteError } = await db.from('questions').delete().in('id', idsToDelete);
                        if (deleteError) {
                             console.error("[SaveQuiz Debug] Delete error:", deleteError);
                             throw deleteError;
                        }
                         console.log("[SaveQuiz Debug] Successfully deleted items:", idsToDelete);
                    }
                }

                showNotification('Quiz saved successfully!');
                document.getElementById('quiz-builder-modal').classList.add('hidden');
                await renderLecturerModules();

            } catch (error) {
                console.error("Error saving quiz:", error);
                showNotification('Error saving quiz: ' + (error.message || 'Unknown error'), 'error');
            }
        }
        // ... (sisa kode JavaScript tidak berubah) ...
         async function deleteQuiz(quizId) {
            if (confirm('Are you sure you want to delete this quiz and all its questions? This action cannot be undone.')) {
                const { error } = await db.from('quizzes').delete().eq('id', quizId);
                if (error) {
                    showNotification('Failed to delete quiz: ' + error.message, 'error');
                } else {
                    showNotification('Quiz deleted successfully.');
                    document.getElementById('quiz-builder-modal').classList.add('hidden');
                    await renderLecturerModules();
                }
            }
        }

        // --- QUIZ TAKER (STUDENT) ---
        
        async function openQuizTakerModal(quizId) {
            if (quizTimerInterval) clearInterval(quizTimerInterval);

            const quizTakerModal = document.getElementById('quiz-taker-modal');
            const { data: quiz } = await db.from('quizzes').select('*').eq('id', quizId).single();
            if (!quiz) return;

            document.getElementById('quiz-taker-modal-title').textContent = quiz.title;
            document.getElementById('quiz-taker-modal-subtitle').textContent = quiz.subtitle || '';
            const contentDiv = document.getElementById('quiz-taker-content');
            contentDiv.innerHTML = '<p>Loading questions...</p>';
            quizTakerModal.classList.remove('hidden');
            const timerDisplay = document.getElementById('quiz-timer-display');
            const timerEl = document.getElementById('quiz-timer');

            const { data: items } = await db.from('questions').select('*').eq('quiz_id', quizId).order('display_order');
            
            if (quiz.duration_minutes && quiz.duration_minutes > 0) {
                timerDisplay.classList.remove('hidden');
                const endTime = new Date().getTime() + quiz.duration_minutes * 60 * 1000;

                quizTimerInterval = setInterval(function() {
                    const now = new Date().getTime();
                    const distance = endTime - now;
                    
                    if (distance < 0) {
                        clearInterval(quizTimerInterval);
                        timerEl.innerHTML = "Waktu Habis";
                        showNotification('Waktu habis! Kuis akan diserahkan secara otomatis.', 'error');
                        const questionsToSubmit = items ? items.filter(i => i.question_type !== 'instructional_text' && i.question_type !== 'reading_passage' && i.question_type !== 'media_embed') : [];
                        submitQuiz(quiz.id, questionsToSubmit);
                        return;
                    }

                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    timerEl.innerHTML = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }, 1000);
            } else {
                timerDisplay.classList.add('hidden');
            }
            
            if (!items || items.length === 0) {
                contentDiv.innerHTML = '<p>This quiz has no questions yet.</p>';
                document.getElementById('submit-quiz-answers').classList.add('hidden');
                if (quizTimerInterval) clearInterval(quizTimerInterval);
                return;
            }
            
            let formHTML = `<form id="quiz-taker-form" class="space-y-6">`;
            let questionCounter = 0;
            items.forEach((item) => {
                if (item.question_type === 'instructional_text') {
                    formHTML += `<div class="pt-2 pb-1 border-t mt-4">
                                     <p class="text-sm italic text-gray-600">${item.question_text}</p>
                                   </div>`;
                } else if (item.question_type === 'reading_passage') {
                    formHTML += `<div class="p-4 border bg-gray-50 rounded-md mt-4 ql-snow">
                                     <h4 class="font-semibold text-gray-800 mb-2">Reading Passage:</h4>
                                     <div class="ql-editor">${item.question_text}</div>
                                   </div>`;
                // Menampilkan media player dari question_text
                } else if (item.question_type === 'media_embed' && item.question_text) {
                    formHTML += `<div class="pt-4 border-t mt-4 space-y-4">`;
                    const mediaUrl = item.question_text;
                    const mediaType = getMediaType(mediaUrl);

                    if (mediaType === 'audio') {
                        // Detect correct MIME type based on file extension
                        let mimeType = 'audio/mpeg';
                        if (mediaUrl.match(/\.mp3$/i)) mimeType = 'audio/mpeg';
                        else if (mediaUrl.match(/\.wav$/i)) mimeType = 'audio/wav';
                        else if (mediaUrl.match(/\.ogg$/i)) mimeType = 'audio/ogg';
                        else if (mediaUrl.match(/\.aac$/i)) mimeType = 'audio/aac';
                        
                        formHTML += `
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Listen to the audio:</label>
                                <audio controls preload="metadata" controlsList="nodownload" class="w-full rounded-md shadow-sm" crossorigin="anonymous">
                                    <source src="${mediaUrl}" type="${mimeType}">
                                    <source src="${mediaUrl}">
                                    Your browser does not support the audio element.
                                </audio>
                            </div>`;
                    } else if (mediaType === 'youtube') {
                        const videoId = getYoutubeVideoId(mediaUrl);
                        formHTML += `<div><label class="block text-sm font-medium text-gray-700 mb-1">Watch the video:</label>`;
                        formHTML += `
                            <div class="responsive-video-embed">
                                <iframe src="https://www.youtube.com/embed/${videoId}" 
                                    title="YouTube video player" frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                                </iframe>
                            </div>`;
                        formHTML += `</div>`;
                    } else if (mediaType === 'video') {
                        // Detect correct video MIME type
                        let videoMimeType = 'video/mp4';
                        if (mediaUrl.match(/\.mp4$/i)) videoMimeType = 'video/mp4';
                        else if (mediaUrl.match(/\.webm$/i)) videoMimeType = 'video/webm';
                        else if (mediaUrl.match(/\.ogv$/i)) videoMimeType = 'video/ogg';
                        
                        formHTML += `<div><label class="block text-sm font-medium text-gray-700 mb-1">Watch the video:</label>`;
                        formHTML += `
                            <div class="responsive-video-embed">
                                <video controls preload="metadata" controlsList="nodownload" class="w-full rounded-md shadow-sm" crossorigin="anonymous">
                                    <source src="${mediaUrl}" type="${videoMimeType}">
                                    <source src="${mediaUrl}">
                                    Your browser does not support the video tag.
                                </video>
                            </div>`;
                        formHTML += `</div>`;
                    }
                    formHTML += `</div>`;
                } else if (item.question_type === 'multiple_choice' || item.question_type === 'fill_in_the_blank') { // Only render actual questions
                    questionCounter++;
                    formHTML += `<div class="pt-4 border-t mt-4">`;
                    if (item.image_url) {
                        formHTML += `<img src="${item.image_url}" alt="Question image" class="max-w-sm mx-auto rounded-md mb-4">`;
                    }
                    formHTML += `<p class="font-medium text-gray-800">${questionCounter}. ${item.question_text}</p>`;
                    if (item.question_type === 'multiple_choice') {
                         formHTML += `<div class="space-y-2 mt-2 ml-4">
                                         ${item.options.map((opt, optIndex) => `<label class="flex items-center"><input type="radio" name="q-${item.id}" value="${optIndex}" class="h-4 w-4 text-indigo-600" required><span class="ml-2 text-gray-700">${opt}</span></label>`).join('')}
                                       </div>`;
                    } else { // fill_in_the_blank
                        formHTML += `<div class="mt-2"><input type="text" name="q-${item.id}" class="w-full p-2 border rounded-md" required></div>`;
                    }
                    formHTML += `</div>`;
                }
            });
            formHTML += '</form>';
            contentDiv.innerHTML = formHTML;

            const questions = items.filter(i => i.question_type !== 'instructional_text' && i.question_type !== 'reading_passage' && i.question_type !== 'media_embed');
            const submitQuizAnswersBtn = document.getElementById('submit-quiz-answers');
            if (questions.length > 0) {
                 submitQuizAnswersBtn.classList.remove('hidden');
                 const newSubmitBtn = submitQuizAnswersBtn.cloneNode(true);
                 submitQuizAnswersBtn.parentNode.replaceChild(newSubmitBtn, submitQuizAnswersBtn);
                 newSubmitBtn.addEventListener('click', () => submitQuiz(quiz.id, questions));
            } else {
                // If there are only non-question items (instructions, media), hide the submit button
                submitQuizAnswersBtn.classList.add('hidden');
            }
        }


        async function submitQuiz(quizId, questions) {
            if (quizTimerInterval) clearInterval(quizTimerInterval);

            const { data: { user }, error: userError } = await db.auth.getUser();
            if (userError || !user) {
                showNotification('Session expired. Please log in again.', 'error');
                return logout();
            }
            
            const form = document.getElementById('quiz-taker-form');
            if (!form) return;

            // Handle the case where there are no questions to answer
            if (questions.length === 0) {
                 document.getElementById('quiz-taker-content').innerHTML = `<div class="text-center">
                                                                             <h2 class="text-2xl font-bold text-indigo-600">Quiz Viewed</h2>
                                                                             <p class="mt-2 text-lg text-gray-700">There were no questions to answer in this quiz.</p>
                                                                          </div>`;
                 document.getElementById('submit-quiz-answers').classList.add('hidden');
                 // Optionally, you could still record completion without a score, or handle as needed
                 // await renderStudentUnifiedView();
                 return;
            }


            const formData = new FormData(form);
            let correctAnswers = 0;
            
            questions.forEach(q => {
                const userAnswer = formData.get(`q-${q.id}`);
                if (q.question_type === 'multiple_choice') {
                    if (userAnswer !== null && parseInt(userAnswer, 10) === q.correct_option) correctAnswers++;
                } else { // fill_in_the_blank
                    if (userAnswer && q.correct_answer_text && userAnswer.trim().toLowerCase() === q.correct_answer_text.trim().toLowerCase()) {
                        correctAnswers++;
                    }
                }
            });

            // Avoid division by zero if questions array somehow becomes empty after filtering
            const score = questions.length > 0 ? Math.round((correctAnswers / questions.length) * 100) : 0;
            
            const { error } = await db.from('scores').upsert({ student_id: user.id, quiz_id: quizId, score }, { onConflict: 'student_id, quiz_id' });


            if (error) {
                showNotification('Error submitting score: ' + error.message, 'error');
            } else {
                document.getElementById('quiz-taker-content').innerHTML = `<div class="text-center">
                                                                             <h2 class="text-2xl font-bold text-indigo-600">Quiz Complete!</h2>
                                                                             <p class="mt-2 text-lg text-gray-700">Your score is:</p>
                                                                             <p class="text-5xl font-bold text-gray-900 mt-4">${score}</p>
                                                                          </div>`;
                document.getElementById('submit-quiz-answers').classList.add('hidden');
                await renderStudentUnifiedView();
            }
        }
        
        // --- RENDER FUNCTIONS ---
        async function renderLecturerStudents() {
            const tableBody = document.getElementById('students-table-body');
            const { data: students, error } = await db.from('students').select('*').order('name');
            
            if (error) {
                console.error("Error fetching students:", error);
                showNotification("Could not fetch student data. Check console for details.", "error");
                return;
            }

            tableBody.innerHTML = '';
            
            if (students && students.length > 0) {
                students.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="px-6 py-4 text-sm text-gray-500">${student.nrp}</td>
                                       <td class="px-6 py-4 text-sm font-medium text-gray-900">${student.name}</td>
                                       <td class="px-6 py-4 text-sm font-medium space-x-4">
                                           <button class="reset-student text-yellow-600 hover:text-yellow-900" data-id="${student.id}" data-name="${student.name}">Reset</button>
                                           <button class="delete-student text-red-600 hover:text-red-900" data-id="${student.id}" data-name="${student.name}">Delete</button>
                                       </td>`;
                    row.querySelector('.delete-student').addEventListener('click', (e) => {
                        const studentId = e.target.dataset.id;
                        const studentName = e.target.dataset.name;
                        
                        showConfirmationModal(
                            `Delete Student`,
                            `Are you sure you want to delete ${studentName}? This will remove their login and all associated data permanently.`,
                            async () => {
                                const { error } = await db.rpc('delete_user_and_profile', { user_id_to_delete: studentId });
                                if (error) {
                                    showNotification('Failed to delete student: ' + error.message, 'error');
                                } else {
                                    showNotification('Student deleted successfully.');
                                    await renderLecturerStudents();
                                }
                            }
                        );
                    });
                    row.querySelector('.reset-student').addEventListener('click', (e) => {
                        const studentId = e.target.dataset.id;
                        const studentName = e.target.dataset.name;

                        showConfirmationModal(
                            `Reset Student Progress`,
                            `Are you sure you want to reset all progress for ${studentName}? This will delete all their scores, attendance, and submissions.`,
                            async () => {
                               const { error } = await db.rpc('reset_student_progress', { student_id_to_reset: studentId });
                               if(error) {
                                    showNotification('Failed to reset progress: ' + error.message, 'error');
                               } else {
                                   showNotification(`${studentName}'s progress has been reset.`);
                                   if (!document.getElementById('lecturer-scores-content').classList.contains('hidden')) {
                                       await renderLecturerScores();
                                   }
                               }
                            }
                        );
                    });
                    tableBody.appendChild(row);
                });
            } else {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center p-4">No students found.</td></tr>';
            }
        }


        async function renderStudentUnifiedView() {
            const user = JSON.parse(sessionStorage.getItem('user'));
            const listContainer = document.getElementById('student-module-list');
            const detailContainer = document.getElementById('student-module-detail');
            listContainer.innerHTML = '<div>Loading modules...</div>';
            detailContainer.innerHTML = `<p class="text-center text-gray-500">Select a module from the left to view its content.</p>`;

            // 1. PASTIKAN "essaySubmissionsRes" SUDAH DITAMBAHKAN DI DAFTAR INI
const [meetingsRes, materialsRes, quizzesRes, scoresRes, attendanceRes, submissionsRes, essaySubmissionsRes] = await Promise.all([
    db.from('meetings').select('*').eq('is_unlocked', true),
    db.from('materials').select('*'),
    db.from('quizzes').select('*'),
    db.from('scores').select('*').eq('student_id', user.id),
    db.from('attendance').select('*').eq('student_id', user.id),
    db.from('submissions').select('*').eq('student_id', user.id),

    // 2. PASTIKAN QUERY INI SUDAH ADA DI AKHIR DAFTAR
    db.from('essay_submissions').select('*').eq('student_id', user.id)
]);
            
            fullStudentData.meetings = meetingsRes.data || [];
            fullStudentData.materials = materialsRes.data || [];
            fullStudentData.quizzes = quizzesRes.data || [];
            fullStudentData.scores = scoresRes.data || [];
            fullStudentData.attendance = attendanceRes.data || [];
            fullStudentData.submissions = submissionsRes.data || [];
            fullStudentData.essaySubmissions = essaySubmissionsRes.data || []; // Simpan data esai yang sudah diambil
            
            const unlockedMeetingNumbers = fullStudentData.meetings.map(m => m.meeting_number);
            const visibleRpsData = dynamicRpsData.filter(item => unlockedMeetingNumbers.includes(item.week));

            listContainer.innerHTML = ''; 

            if (visibleRpsData.length === 0) {
                detailContainer.innerHTML = '<p class="text-center text-gray-500 italic mt-4">No learning modules have been unlocked by the lecturer yet.</p>';
                listContainer.innerHTML = '<p class="text-center text-sm text-gray-400">No meetings available.</p>';
                return;
            }

            visibleRpsData.forEach(rpsItem => {
                const meetingNumber = rpsItem.week;
                const listItem = document.createElement('div');
                listItem.className = 'module-item p-3 text-sm rounded-md cursor-pointer text-slate-300 hover:bg-slate-700 hover:text-white transition-all';
                listItem.dataset.meetingNumber = meetingNumber;
                listItem.innerHTML = `
                    <p class="font-semibold">${rpsItem.topic}</p>
                `;
                listItem.addEventListener('click', () => {
                    document.querySelectorAll('.module-item').forEach(item => item.classList.remove('active'));
                    listItem.classList.add('active');
                    renderModuleDetail(meetingNumber);
                });
                listContainer.appendChild(listItem);
            });
            
            const activeModuleLink = currentlyViewedMeeting 
                ? listContainer.querySelector(`[data-meeting-number="${currentlyViewedMeeting}"]`) 
                : null;
            
            if (activeModuleLink) {
                activeModuleLink.click();
            } else if (listContainer.firstChild) {
                listContainer.firstChild.click();
            }
        }
        
        function renderModuleDetail(meetingNumber) {
            currentlyViewedMeeting = meetingNumber;
            const detailContainer = document.getElementById('student-module-detail');
            const rpsItem = dynamicRpsData.find(item => item.week == meetingNumber);
            const material = fullStudentData.materials.find(m => m.meeting == meetingNumber);
            const quiz = fullStudentData.quizzes.find(q => q.meeting == meetingNumber);
            const score = fullStudentData.scores.find(s => quiz && s.quiz_id === quiz.id);
            const attendance = fullStudentData.attendance.find(a => a.meeting_number == meetingNumber);
            const user = JSON.parse(sessionStorage.getItem('user'));
            const meetingData = fullStudentData.meetings.find(m => m.meeting_number == meetingNumber);
            
            const submissionsForMeeting = fullStudentData.submissions
                .filter(s => s.meeting_number == meetingNumber)
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); // Sort by most recent first
            const submission = submissionsForMeeting.length > 0 ? submissionsForMeeting[0] : null;
            // Ambil data esai yang sudah disimpan (jika ada) untuk meeting ini
const essaySubmission = fullStudentData.essaySubmissions.find(e => e.meeting_number == meetingNumber);

            let meetingTitle = `Meeting ${meetingNumber}: ${rpsItem.topic}`;
            if (meetingNumber == 8) meetingTitle = 'MIDTERM EXAM (UTS)';
            if (meetingNumber == 16) meetingTitle = 'FINAL EXAM (UAS)';
            
            let moduleHTML = `<h3 class="text-3xl font-bold text-gray-800 mb-2">${meetingTitle}</h3>
                                            <p class="text-gray-500 mb-6 pb-4 border-b">${rpsItem.description}</p>`;
            
            if (!attendance) {
                 moduleHTML += `<div class="text-center p-8 bg-gray-50 rounded-lg">
                                                <h4 class="text-lg font-semibold mb-4 text-gray-700">You need to mark your attendance to view this module's content.</h4>
                                                <button data-meeting-number="${meetingNumber}" class="mark-present-btn bg-indigo-600 text-white px-6 py-3 rounded-md hover:bg-indigo-700 transition-all font-semibold">Mark as Present</button>
                                              </div>`;
            } else {
                let hasContent = false;
                if (material) {
                    hasContent = true;
                    moduleHTML += `<div class="prose max-w-none ql-snow mb-8"><div class="ql-editor">${material.content}</div></div>`;
                    
                    let mediaHTML = '';
                    if (material.video_url) {
                        const videoId = getYoutubeVideoId(material.video_url);
                        
                        if (videoId) {
                            const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                            const fallbackThumbnailUrl = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
                            mediaHTML += `
                                <div class="mt-6">
                                    <h4 class="text-lg font-semibold text-gray-700 mb-2">Video Material</h4>
                                    <a href="${material.video_url}" target="_blank" rel="noopener noreferrer" class="block relative group">
                                        <img 
                                            src="${thumbnailUrl}" 
                                            onerror="this.onerror=null; this.src='${fallbackThumbnailUrl}';" 
                                            alt="Video Thumbnail" 
                                            class="w-full rounded-lg shadow-md cursor-pointer transition-transform duration-300 group-hover:scale-105"
                                        >
                                        <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-40 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                            <svg class="w-16 h-16 text-white" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                                        </div>
                                    </a>
                                    <p class="text-xs text-center text-gray-500 mt-2">
                                        Klik pada gambar untuk menonton video di YouTube.
                                    </p>
                                </div>
                            `;
                        } else {
                             // Fallback for non-youtube links
                             mediaHTML += `
                                <div class="mt-6">
                                    <h4 class="text-lg font-semibold text-gray-700 mb-2">Video Link</h4>
                                    <a href="${material.video_url}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline break-all">${material.video_url}</a>
                                </div>
                             `;
                        }
                    }
                    if (material.audio_url) {
                        mediaHTML += `
                            <div class="mt-6">
                                <h4 class="text-lg font-semibold text-gray-700 mb-2">Audio Material</h4>
                                <audio controls class="w-full rounded-lg shadow-md">
                                    <source src="${material.audio_url}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                            </div>
                        `;
                    }
                    if(mediaHTML) {
                        moduleHTML += '<hr class="my-6">' + mediaHTML;
                    }

                }
                
                if (quiz) {
                    hasContent = true;
                    if (material) moduleHTML += '<hr class="my-6">';
                    
                    if (meetingData?.quiz_enabled) {
                         const buttonOrScoreHTML = score
                            ? `<div class="text-right"><p class="font-bold text-2xl text-indigo-600">${score.score}</p><p class="text-sm text-gray-500">Your Score</p></div>`
                            : `<button data-quiz-id="${quiz.id}" class="take-quiz-btn bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700 font-semibold">Take Quiz</button>`;
                        
                        let durationInfo = '';
                        if(quiz.duration_minutes){
                            durationInfo = `<p class="text-sm text-gray-600 ml-10 mt-1 flex items-center"><i data-feather="clock" class="w-4 h-4 mr-1"></i> Durasi: ${quiz.duration_minutes} menit</p>`
                        }

                        moduleHTML += `<div class="bg-gray-50 rounded-lg p-6 flex justify-between items-center">
                            <div>
                                <div class="flex items-center"><i data-feather="edit-3" class="text-green-600 mr-4"></i><h4 class="text-xl font-semibold text-gray-800">${quiz.title}</h4></div>
                                ${quiz.subtitle ? `<p class="text-sm text-gray-600 ml-10 mt-1">${quiz.subtitle}</p>` : ''}
                                ${durationInfo}
                            </div>
                            ${buttonOrScoreHTML}
                        </div>`;
                    } else {
                        moduleHTML += `<div class="bg-gray-50 rounded-lg p-6 flex justify-between items-center">
                            <div>
                                <div class="flex items-center"><i data-feather="slash" class="text-gray-500 mr-4"></i><h4 class="text-xl font-semibold text-gray-800">${quiz.title}</h4></div>
                                 ${quiz.subtitle ? `<p class="text-sm text-gray-600 ml-10 mt-1">${quiz.subtitle}</p>` : ''}
                            </div>
                            <p class="text-sm text-gray-600">Quiz is currently disabled.</p>
                        </div>`;
                    }
                }

                // Submission Section
                if (meetingData?.assignment_enabled) {
                    hasContent = true;
                    if (material || quiz) moduleHTML += '<hr class="my-8">';
                    moduleHTML += `<div class="bg-blue-50 rounded-lg p-6">
                        <h4 class="text-xl font-semibold text-gray-800 mb-4 flex items-center"><i data-feather="upload" class="text-blue-600 mr-3"></i>Assignment Submission</h4>`;

                    if (submission) {
                        moduleHTML += `<p class="text-gray-700">You have submitted:</p>
                            <a href="${submission.file_url}" target="_blank" class="font-medium text-indigo-600 hover:text-indigo-800">${submission.file_name}</a>
                            <p class="text-sm text-gray-500 mt-4">To replace the file, please upload a new one.</p>
                            <input type="file" class="submission-file-input mt-2 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <button data-meeting-number="${meetingNumber}" class="submit-assignment-btn mt-2 bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700 font-semibold">Upload New File</button>`;
                    } else {
                        moduleHTML += `<p class="text-gray-700 mb-4">Please upload your assignment file for this meeting.</p>
                            <input type="file" class="submission-file-input block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <button data-meeting-number="${meetingNumber}" class="submit-assignment-btn mt-4 bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700 font-semibold">Upload File</button>`;
                    }
                    moduleHTML += `</div>`;
                
                }
                // --- AWAL BLOK ESSAY BARU ---
if (meetingData?.essay_enabled) {
    hasContent = true;
    // Beri pemisah jika ada konten lain di atasnya
    if (material || quiz || meetingData?.assignment_enabled) {
        moduleHTML += '<hr class="my-8">';
    }

    moduleHTML += `
        <div class="bg-purple-50 rounded-lg p-6 shadow-sm">
            <h4 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <i data-feather="edit" class="text-purple-600 mr-3"></i>Type Your Answer Here
            </h4>
            <p class="text-gray-700 mb-4">Please type down your answer here.</p>

            <textarea id="essay-textarea-${meetingNumber}" class="w-full h-80 p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Mulai tulis esai Anda di sini...">${essaySubmission?.content || ''}</textarea>

            <div class="mt-4 flex justify-end items-center">
                <span id="essay-save-status-${meetingNumber}" class="text-sm text-gray-500 mr-4"></span>

                <button data-meeting-number="${meetingNumber}" class="save-essay-btn bg-purple-600 text-white px-5 py-2 rounded-md hover:bg-purple-700 font-semibold transition-all">
                    Save
                </button>
            </div>
        </div>
    `;
}
// --- AKHIR BLOK ESSAY BARU ---

                if (!hasContent) {
                    moduleHTML += '<p class="text-center text-gray-400 italic mt-8">Content for this module will be available soon.</p>';
                }
            }
            
            detailContainer.innerHTML = moduleHTML;
            feather.replace();
            detailContainer.querySelectorAll('.take-quiz-btn').forEach(btn => {
                btn.addEventListener('click', (e) => openQuizTakerModal(e.currentTarget.dataset.quizId));
            });
            detailContainer.querySelectorAll('.mark-present-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const meetingNum = e.currentTarget.dataset.meetingNumber;
                    const { data: { user }, error: userError } = await db.auth.getUser();
                    if (userError || !user) {
                        showNotification('Session expired. Please log in again.', 'error');
                        return logout();
                    }
                    const { error } = await db.from('attendance').insert({ student_id: user.id, meeting_number: meetingNum });
                    if(error) {
                        showNotification('Attendance already marked or error: ' + error.message, 'error');
                    } else {
                        showNotification(`You are marked present for Meeting ${meetingNum}.`);
                        fullStudentData.attendance.push({student_id: user.id, meeting_number: parseInt(meetingNum, 10) });
                        renderModuleDetail(meetingNum);
                    }
                });
            });
             detailContainer.querySelectorAll('.submit-assignment-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const meetingNum = e.currentTarget.dataset.meetingNumber;
                    const fileInput = e.currentTarget.previousElementSibling;
                    handleFileSubmission(meetingNum, fileInput);
                });
            });
             // LISTENER UNTUK TOMBOL SIMPAN ESSAY BARU
detailContainer.querySelectorAll('.save-essay-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const meetingNum = e.currentTarget.dataset.meetingNumber;
        const textarea = document.getElementById(`essay-textarea-${meetingNum}`);
        handleEssaySubmission(meetingNum, textarea);
    });
});
        }

        async function handleFileSubmission(meetingNumber, fileInput) {
            const { data: { user }, error: userError } = await db.auth.getUser();
            if (userError || !user) {
                showNotification('Session expired. Please log in again.', 'error');
                return logout();
            }
            const file = fileInput.files[0];

            if (!file) {
                showNotification('Please select a file to upload.', 'error');
                return;
            }

            showNotification('Uploading file...', 'success');
            const filePath = `public/submissions/${user.id}/${meetingNumber}-${file.name}`;
            
            const { error: uploadError } = await db.storage
                .from('materials')
                .upload(filePath, file, { upsert: true });

            if (uploadError) {
                showNotification('File upload failed: ' + uploadError.message, 'error');
                return;
            }

            const { data: urlData } = db.storage.from('materials').getPublicUrl(filePath);
            
            const submissionData = {
                student_id: user.id,
                meeting_number: meetingNumber,
                file_name: file.name,
                file_url: urlData.publicUrl
            };
            
            // Check if a submission for this student and meeting already exists.
            const { data: existingSubmission, error: fetchError } = await db
                .from('submissions')
                .select('id')
                .eq('student_id', user.id)
                .eq('meeting_number', meetingNumber)
                .single();

            // If there's an error and it's not the "no rows found" error, show it.
            if (fetchError && fetchError.code !== 'PGRST116') {
                showNotification('Error checking submission: ' + fetchError.message, 'error');
                return;
            }

            let finalError;

            if (existingSubmission) {
                // If it exists, update it.
                const { error: updateError } = await db.from('submissions')
                    .update({
                        file_name: file.name,
                        file_url: urlData.publicUrl,
                        created_at: new Date().toISOString() // Also update the timestamp
                    })
                    .eq('id', existingSubmission.id);
                finalError = updateError;
            } else {
                // If it doesn't exist, insert a new one.
                const { error: insertError } = await db.from('submissions').insert(submissionData);
                finalError = insertError;
            }
            
            if (finalError) {
                showNotification('Failed to save submission record: ' + finalError.message, 'error');
            } else {
                showNotification('Assignment submitted successfully!');
                await renderStudentUnifiedView();
            }
        }
        
        // FUNGSI BARU UNTUK MENYIMPAN ESSAY
async function handleEssaySubmission(meetingNumber, textarea) {
    const { data: { user }, error: userError } = await db.auth.getUser();
    if (userError || !user) {
        showNotification('Sesi berakhir. Silakan login kembali.', 'error');
        return logout();
    }

    const content = textarea.value;
    const statusEl = document.getElementById(`essay-save-status-${meetingNumber}`);
    statusEl.textContent = 'Menyimpan...';
    statusEl.classList.remove('text-red-500');
    statusEl.classList.remove('text-green-500');

    // Gunakan upsert() untuk membuat baru ATAU update jika sudah ada
    const { error } = await db.from('essay_submissions').upsert({
        student_id: user.id,
        meeting_number: meetingNumber,
        content: content,
        updated_at: new Date().toISOString()
    }, {
        onConflict: 'student_id, meeting_number' // Ini penting, berdasarkan UNIQUE constraint yg kita buat di SQL
    });

    if (error) {
        showNotification('Gagal menyimpan esai: ' + error.message, 'error');
        statusEl.textContent = 'Gagal menyimpan.';
        statusEl.classList.add('text-red-500');
    } else {
        // Berhasil!
        statusEl.textContent = 'Berhasil disimpan!';
        statusEl.classList.add('text-green-500');

        // Perbarui juga data di "fullStudentData" agar konsisten
        let existing = fullStudentData.essaySubmissions.find(e => e.student_id === user.id && e.meeting_number == meetingNumber);
        if (existing) {
            existing.content = content;
        } else {
            fullStudentData.essaySubmissions.push({ student_id: user.id, meeting_number: meetingNumber, content: content });
        }

        // Hilangkan pesan status setelah 3 detik
        setTimeout(() => { statusEl.textContent = ''; }, 3000);
    }
}
// FUNGSI BARU UNTUK MEMBUKA MODAL EDIT RPS
function openRpsEditModal(rpsItem) {
    // Isi form modal dengan data yang ada
    document.getElementById('rps-week-id').value = rpsItem.week;
    document.getElementById('rps-topic').value = rpsItem.topic;
    document.getElementById('rps-description').value = rpsItem.description;
    document.getElementById('rps-modal-title').textContent = `Edit Meeting ${rpsItem.week}`;

    // Tampilkan modalnya
    document.getElementById('rps-edit-modal').classList.remove('hidden');
}

// FUNGSI BARU UNTUK MENUTUP MODAL EDIT RPS
function closeRpsEditModal() {
    document.getElementById('rps-edit-modal').classList.add('hidden');
    document.getElementById('rps-edit-form').reset();
}

// FUNGSI BARU UNTUK MENYIMPAN PERUBAHAN RPS
async function saveRpsChanges() {
    const week = document.getElementById('rps-week-id').value;
    const topic = document.getElementById('rps-topic').value;
    const description = document.getElementById('rps-description').value;

    if (!topic) {
        showNotification("Meeting title cannot be empty.", "error");
        return;
    }

    // Kirim update ke Supabase
    const { error } = await db.from('rps').update({ 
        topic: topic, 
        description: description 
    }).eq('week', week);

    if (error) {
        showNotification("Error saving changes: " + error.message, "error");
    } else {
        showNotification("Meeting details updated successfully!");
        closeRpsEditModal();

        // PENTING: Ambil data baru dari DB dan gambar ulang modulnya
        await fetchRpsData(); 
        await renderLecturerModules();
    }
}
        async function renderLecturerModules() {
            const container = document.getElementById('lecturer-modules-list');
            if (!container) return; // Guard clause
            container.innerHTML = '<div>Loading modules...</div>';

            const [meetingsRes, materialsRes, quizzesRes] = await Promise.all([
                db.from('meetings').select('*'),
                db.from('materials').select('*'),
                db.from('quizzes').select('*')
            ]);
            
            const meetings = meetingsRes.data || [];
            const materials = materialsRes.data || [];
            const quizzes = quizzesRes.data || [];
            container.innerHTML = '';

            dynamicRpsData.forEach(rpsItem => {
                const meetingNumber = rpsItem.week;
                const meeting = meetings.find(m => m.meeting_number == meetingNumber);
                const material = materials.find(m => m.meeting == meetingNumber);
                const quiz = quizzes.find(q => q.meeting == meetingNumber);

                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-md flex flex-col transition-all hover:shadow-lg hover:-translate-y-1';
                
                let cardHTML = `
                    <div class="flex-grow">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="text-md font-bold text-gray-800">Meeting ${meetingNumber}</h4>
                            <div class="flex items-center space-x-3">
                                
                                <div class="flex items-center space-x-1">
                                    <label for="quiz-toggle-${meetingNumber}" class="text-xs text-gray-500 cursor-pointer">Quiz</label>
                                    <div class="relative inline-block w-10 align-middle select-none">
                                        <input type="checkbox" name="quiz-toggle" id="quiz-toggle-${meetingNumber}" class="quiz-toggle-checkbox toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${meeting?.quiz_enabled ? 'checked' : ''}/>
                                        <label for="quiz-toggle-${meetingNumber}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                    </div>
                                </div>
                                
                                <div class="flex items-center space-x-1">
    <label for="essay-toggle-${meetingNumber}" class="text-xs text-gray-500 cursor-pointer">Essay</label>
    <div class="relative inline-block w-10 align-middle select-none">
        <input type="checkbox" name="essay-toggle" id="essay-toggle-${meetingNumber}" class="essay-toggle-checkbox toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${meeting?.essay_enabled ? 'checked' : ''}/>
        <label for="essay-toggle-${meetingNumber}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
    </div>
</div>

                                <div class="flex items-center space-x-1">
                                    <label for="submission-toggle-${meetingNumber}" class="text-xs text-gray-500 cursor-pointer">Uploads</label>
                                    <div class="relative inline-block w-10 align-middle select-none">
                                        <input type="checkbox" name="submission-toggle" id="submission-toggle-${meetingNumber}" class="submission-toggle-checkbox toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${meeting?.assignment_enabled ? 'checked' : ''}/>
                                        <label for="submission-toggle-${meetingNumber}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                    </div>
                                </div>
                                 <div class="flex items-center space-x-1">
                                    <label for="unlock-toggle-${meetingNumber}" class="text-xs text-gray-500 cursor-pointer">Unlock</label>
                                    <div class="relative inline-block w-10 align-middle select-none">
                                        <input type="checkbox" name="unlock-toggle" id="unlock-toggle-${meetingNumber}" class="unlock-toggle-checkbox toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${meeting?.is_unlocked ? 'checked' : ''}/>
                                        <label for="unlock-toggle-${meetingNumber}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">${rpsItem.topic}</p>
                        <div class="text-xs mt-4 space-y-1">
                            <p class="flex items-center ${material ? 'text-green-600' : 'text-gray-400'}"><i data-feather="${material ? 'check-circle' : 'circle'}" class="w-4 h-4 mr-2"></i> Material</p>
                            <p class="flex items-center ${quiz ? 'text-green-600' : 'text-gray-400'}"><i data-feather="${quiz ? 'check-circle' : 'circle'}" class="w-4 h-4 mr-2"></i> Quiz / Exam</p>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t flex justify-between items-center">
    <button class="edit-rps-btn text-indigo-600 hover:text-indigo-800" data-week="${meetingNumber}">
        <i data-feather="edit-2" class="w-4 h-4"></i>
    </button>

    <div class="space-x-2">
        <button class="manage-material-btn text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded">Material</button>
        <button class="manage-quiz-btn text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded">${[8, 16].includes(meetingNumber) ? 'Exam' : 'Quiz'}</button>
    </div>
</div>
                `;
                card.innerHTML = cardHTML;
                
                card.querySelector('.unlock-toggle-checkbox').addEventListener('change', async (e) => {
                    const { error } = await db.from('meetings').update({ is_unlocked: e.target.checked }).eq('meeting_number', meetingNumber);
                    if (error) {
                        showNotification('Error: ' + error.message, 'error');
                        e.target.checked = !e.target.checked; // Revert on failure
                    } else {
                        showNotification(`Module ${meetingNumber} has been ${e.target.checked ? 'unlocked' : 'locked'}.`);
                    }
                });

                 card.querySelector('.submission-toggle-checkbox').addEventListener('change', async (e) => {
                    const { error } = await db.from('meetings').update({ assignment_enabled: e.target.checked }).eq('meeting_number', meetingNumber);
                    if (error) {
                        showNotification('Error: ' + error.message, 'error');
                        e.target.checked = !e.target.checked; // Revert on failure
                    } else {
                        showNotification(`File submission for Module ${meetingNumber} has been ${e.target.checked ? 'enabled' : 'disabled'}.`);
                    }
                });

                 // LISTENER UNTUK TOGGLE ESSAY BARU
card.querySelector('.essay-toggle-checkbox').addEventListener('change', async (e) => {
    const { error } = await db.from('meetings').update({ essay_enabled: e.target.checked }).eq('meeting_number', meetingNumber);
    if (error) {
        showNotification('Error: ' + error.message, 'error');
        e.target.checked = !e.target.checked; // Kembalikan jika gagal
    } else {
        showNotification(`Essay task for Module ${meetingNumber} has been ${e.target.checked ? 'enabled' : 'disabled'}.`);
    }
});

                card.querySelector('.quiz-toggle-checkbox').addEventListener('change', async (e) => {
                    const { error } = await db.from('meetings').update({ quiz_enabled: e.target.checked }).eq('meeting_number', meetingNumber);
                    if (error) {
                        showNotification('Error: ' + error.message, 'error');
                        e.target.checked = !e.target.checked; // Revert on failure
                    } else {
                        showNotification(`Quiz for Module ${meetingNumber} has been ${e.target.checked ? 'enabled' : 'disabled'}.`);
                    }
                });
                
                card.querySelector('.manage-material-btn').addEventListener('click', () => openMaterialModal(material, meetingNumber));
                card.querySelector('.manage-quiz-btn').addEventListener('click', () => openQuizBuilderModal(quiz, meetingNumber));
// Listener untuk tombol "edit" (ikon pensil)
card.querySelector('.edit-rps-btn').addEventListener('click', () => {
    // Tidak perlu mencari lagi, 'rpsItem' sudah benar dari loop-nya
    if (rpsItem) {
        openRpsEditModal(rpsItem);
    } else {
        // Ini seharusnya tidak pernah terjadi, tapi bagus untuk jaga-jaga
        showNotification("Error: Tidak bisa memuat data untuk meeting ini.", "error");
    }
});
                container.appendChild(card);
            });
            feather.replace();
        }

        async function renderLecturerAttendance() {
            const meetingNumber = document.getElementById('attendance-meeting-select').value;
            const tableBody = document.getElementById('attendance-table-body');
            if(!tableBody) return;
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center p-4">Loading attendance data...</td></tr>';
            
            const [studentsRes, attendanceRes] = await Promise.all([
                db.from('students').select('*').order('name'),
                db.from('attendance').select('*').eq('meeting_number', meetingNumber)
            ]);

            const students = studentsRes.data || [];
            const attendanceRecords = attendanceRes.data || [];
            tableBody.innerHTML = '';

            students.forEach(student => {
                const hasAttended = attendanceRecords.some(record => record.student_id === student.id);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-500">${student.nrp}</td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${student.name}</td>
                    <td class="px-6 py-4 text-sm">
                        <button 
                            data-student-id="${student.id}" 
                            data-meeting-number="${meetingNumber}" 
                            data-attended="${hasAttended}" 
                            class="attendance-toggle-btn cursor-pointer px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${hasAttended ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${hasAttended ? 'Present' : 'Absent'}
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            tableBody.querySelectorAll('.attendance-toggle-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const studentId = e.target.dataset.studentId;
                    const meetingNum = e.target.dataset.meetingNumber;
                    const isAttended = e.target.dataset.attended === 'true';

                    if (isAttended) {
                        // Delete attendance record
                        const { error } = await db.from('attendance').delete().match({ student_id: studentId, meeting_number: meetingNum });
                        if (error) {
                            showNotification('Failed to update attendance: ' + error.message, 'error');
                        } else {
                            showNotification('Attendance updated.', 'success');
                            renderLecturerAttendance(); // Re-render the table
                        }
                    } else {
                        // Insert attendance record
                        const { error } = await db.from('attendance').insert({ student_id: studentId, meeting_number: meetingNum });
                        if (error) {
                            showNotification('Failed to update attendance: ' + error.message, 'error');
                        } else {
                            showNotification('Attendance updated.', 'success');
                            renderLecturerAttendance(); // Re-render the table
                        }
                    }
                });
            });
        }
        
        async function renderLecturerSubmissions(meetingNumber = 1) {
    const tableBody = document.getElementById('submission-table-body');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Loading submissions...</td></tr>'; // Tambah 1 kolom

    // Parse meeting number
    const meetingNumInt = parseInt(meetingNumber, 10) || 1;

    // Ambil semua data mahasiswa
    const { data: students, error: studentsError } = await db.from('students').select('id, nrp, name').order('name');
    if (studentsError) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Could not load students.</td></tr>';
        return;
    }

    // Ambil data file submissions
    const { data: fileSubmissions, error: fileError } = await db
        .from('submissions')
        .select('*')
        .eq('meeting_number', meetingNumInt);

    // Ambil data essay submissions  
    const { data: essaySubmissions, error: essayError } = await db
        .from('essay_submissions')
        .select('*')
        .eq('meeting_number', meetingNumInt);

    if (fileError && essayError) {
        console.error("Error fetching submissions:", fileError, essayError);
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Could not load submissions.</td></tr>';
        return;
    }

    // Gabungkan data file dan essay submissions
    const allSubmissions = [];
    if (fileSubmissions) {
        fileSubmissions.forEach(sub => {
            allSubmissions.push({
                student_id: sub.student_id,
                meeting_number: sub.meeting_number,
                submission_type: 'file',
                file_name: sub.file_name,
                file_url: sub.file_url,
                content: null
            });
        });
    }
    if (essaySubmissions) {
        essaySubmissions.forEach(essay => {
            allSubmissions.push({
                student_id: essay.student_id,
                meeting_number: essay.meeting_number,
                submission_type: 'essay',
                file_name: null,
                file_url: null,
                content: essay.content
            });
        });
    }

    // Ubah nama kolom header dari "File" menjadi "Submission"
    const headerRow = document.querySelector("#lecturer-submissions-content thead tr");
    if (headerRow) {
        if (headerRow.children[2]) {
            headerRow.children[2].textContent = "Submission";
        }
        // Tambahkan header "Score" jika belum ada
        if (headerRow.children.length < 4) {
            const scoreHeader = document.createElement('th');
            scoreHeader.scope = 'col';
            scoreHeader.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
            scoreHeader.textContent = 'Score';
            headerRow.appendChild(scoreHeader);
        }
    }

    tableBody.innerHTML = ''; // Kosongkan tabel

    if (students.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">No students registered yet.</td></tr>';
        return;
    }

    // Kita perlu data score yang sudah ada
    const { data: fileScores } = await db.from('submissions').select('student_id, score').eq('meeting_number', meetingNumInt);
    const { data: essayScores } = await db.from('essay_submissions').select('student_id, score').eq('meeting_number', meetingNumInt);

    students.forEach(student => {
        // Cari submission (file ATAU esai) untuk mahasiswa ini
        const submission = allSubmissions.find(s => s.student_id === student.id);
        const row = document.createElement('tr');
        
        let submissionHTML = '<span class="text-gray-400">No submission</span>';
        let submissionType = null;
        let currentScore = '';

        if (submission) {
            if (submission.submission_type === 'file') {
                submissionType = 'submissions'; // Nama tabel
                const scoreRecord = fileScores.find(s => s.student_id === student.id);
                currentScore = scoreRecord?.score ?? '';
                submissionHTML = `<a href="${submission.file_url}" target="_blank" class="text-indigo-600 hover:text-indigo-800 flex items-center">
                                    <i data-feather="download" class="w-4 h-4 mr-2"></i>${submission.file_name}
                                </a>`;
            } else if (submission.submission_type === 'essay' && submission.content) {
                submissionType = 'essay_submissions'; // Nama tabel
                const scoreRecord = essayScores.find(s => s.student_id === student.id);
                currentScore = scoreRecord?.score ?? '';
                submissionHTML = `<button 
                                    class="view-essay-btn text-purple-600 hover:text-purple-800 flex items-center"
                                    data-student-name="${student.name}"
                                    data-content="${encodeURIComponent(submission.content)}">
                                    <i data-feather="file-text" class="w-4 h-4 mr-2"></i>View Essay
                                </button>`;
            } else if (submission.submission_type === 'essay' && !submission.content) {
                submissionHTML = '<span class="text-gray-500 italic">Empty Essay</span>';
            }
        }

        // KOTAK INPUT NILAI BARU
        const scoreInputHTML = `
            <input 
                type="number" 
                min="0" 
                max="100" 
                class="submission-score-input w-20 p-1 text-center border rounded-md" 
                value="${currentScore}" 
                ${!submission ? 'disabled' : ''}
                data-student-id="${student.id}"
                data-meeting-number="${meetingNumInt}"
                data-table-name="${submissionType}"
            >
        `;

        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.nrp}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${submissionHTML}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${scoreInputHTML}</td>
        `;
        tableBody.appendChild(row);
    });
    
    // --- PASANG LISTENER UNTUK MODAL EASSY ---
    tableBody.querySelectorAll('.view-essay-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const btn = e.currentTarget;
            const studentName = btn.dataset.studentName;
            const essayContent = decodeURIComponent(btn.dataset.content);
            document.getElementById('essay-viewer-student').textContent = `Submitted by: ${studentName}`;
            document.getElementById('essay-viewer-content').innerHTML = essayContent.replace(/\n/g, '<br>'); 
            document.getElementById('essay-viewer-modal').classList.remove('hidden');
        });
    });

    // --- LISTENER BARU UNTUK INPUT NILAI ---
    tableBody.querySelectorAll('.submission-score-input').forEach(input => {
        input.addEventListener('blur', async (e) => { // 'blur' = saat fokus hilang
            const studentId = e.target.dataset.studentId;
            const meetingNum = e.target.dataset.meetingNumber;
            const tableName = e.target.dataset.tableName;
            const newScore = e.target.value;

            if (!tableName || tableName === 'null') return; // Jangan simpan jika tidak ada submission

            const { error } = await db.from(tableName)
                .update({ score: newScore })
                .match({ student_id: studentId, meeting_number: meetingNum });

            if (error) {
                showNotification(`Gagal menyimpan nilai: ${error.message}`, 'error');
                e.target.style.borderColor = 'red';
            } else {
                showNotification('Nilai berhasil disimpan!', 'success');
                e.target.style.borderColor = 'green';
                setTimeout(() => { e.target.style.borderColor = ''; }, 2000);
            }
        });
    });

    feather.replace(); 
}

        async function renderLecturerScores() {
            const headContainer = document.getElementById('scores-table-head');
            const bodyContainer = document.getElementById('scores-table-body');
            headContainer.innerHTML = '';
            bodyContainer.innerHTML = '<tr><td colspan="100%" class="text-center p-4">Loading scores...</td></tr>';

            const [studentsRes, quizzesRes, scoresRes] = await Promise.all([
                db.from('students').select('*').order('name'),
                db.from('quizzes').select('*'),
                db.from('scores').select('*')
            ]);

            const students = studentsRes.data || [];
            const quizzes = quizzesRes.data || [];
            const scores = scoresRes.data || [];

            const regularMeetings = [1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15];
            const utsMeeting = 8;
            const uasMeeting = 16;
            
            const quizzesByMeeting = quizzes.reduce((acc, quiz) => {
                acc[quiz.meeting] = quiz;
                return acc;
            }, {});

            // 1. Build the dynamic header
            let headerHTML = '<tr>';
            headerHTML += '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NRP</th>';
            headerHTML += '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>';
            regularMeetings.forEach(num => {
                const quiz = quizzesByMeeting[num];
                headerHTML += `<th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" title="${quiz ? quiz.title : ''}">M${num}</th>`;
            });
            const utsQuiz = quizzesByMeeting[utsMeeting];
            headerHTML += `<th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider font-bold bg-yellow-100" title="${utsQuiz ? utsQuiz.title : ''}">UTS</th>`;
            const uasQuiz = quizzesByMeeting[uasMeeting];
            headerHTML += `<th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider font-bold bg-yellow-100" title="${uasQuiz ? uasQuiz.title : ''}">UAS</th>`;
            headerHTML += '</tr>';
            headContainer.innerHTML = headerHTML;

            // 2. Build the body
            bodyContainer.innerHTML = '';
            if (students.length === 0) {
                 bodyContainer.innerHTML = '<tr><td colspan="100%" class="text-center p-4">No students registered yet.</td></tr>';
                 return;
            }

            students.forEach(student => {
                let rowHTML = '<tr>';
                rowHTML += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.nrp}</td>`;
                rowHTML += `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>`;

                const getScore = (meetingNum, forInput = false) => {
                    const quiz = quizzesByMeeting[meetingNum];
                    if (!quiz) return forInput ? '' : '-';
                    const scoreRecord = scores.find(s => s.student_id === student.id && s.quiz_id === quiz.id);
                    if (forInput) {
                        return scoreRecord ? scoreRecord.score : '';
                    }
                    return scoreRecord ? scoreRecord.score : '-';
                };
                
                const createScoreCell = (meetingNum) => {
                    const quiz = quizzesByMeeting[meetingNum];
                    const scoreValue = getScore(meetingNum, true);
                    return `
                        <div class="flex items-center justify-center space-x-1">
                            <input type="number" value="${scoreValue}" min="0" max="100" data-student-id="${student.id}" data-quiz-id="${quiz ? quiz.id : ''}"
                                class="score-input w-20 p-1 text-center border rounded-md bg-gray-50 disabled:bg-gray-200" ${!quiz ? 'disabled' : ''}>
                            <button 
                                class="reset-score-btn text-gray-400 hover:text-red-600 disabled:opacity-50 disabled:cursor-not-allowed" 
                                data-student-id="${student.id}" 
                                data-quiz-id="${quiz ? quiz.id : ''}"
                                data-student-name="${student.name}"
                                data-meeting-number="${meetingNum}"
                                ${!scoreValue ? 'disabled' : ''}>
                                <i data-feather="refresh-cw" class="w-3 h-3"></i>
                            </button>
                        </div>
                    `;
                };

                regularMeetings.forEach(num => {
                    rowHTML += `<td class="px-1 py-1 whitespace-nowrap text-sm text-gray-500 text-center">${createScoreCell(num)}</td>`;
                });
                
                rowHTML += `<td class="px-1 py-1 whitespace-nowrap text-sm text-gray-500 text-center bg-yellow-50">${createScoreCell(utsMeeting)}</td>`;
                rowHTML += `<td class="px-1 py-1 whitespace-nowrap text-sm text-gray-500 text-center bg-yellow-50">${createScoreCell(uasMeeting)}</td>`;


                rowHTML += '</tr>';
                bodyContainer.innerHTML += rowHTML;
            });
            
            bodyContainer.querySelectorAll('.score-input').forEach(input => {
                input.addEventListener('blur', async (e) => {
                    const studentId = e.target.dataset.studentId;
                    const quizId = e.target.dataset.quizId;
                    const newScore = e.target.value;

                    if (!quizId || !studentId) return;

                    if (newScore === '' || newScore === null) {
                        const { error } = await db.from('scores').delete().match({ student_id: studentId, quiz_id: quizId });
                        if (error) {
                            showNotification(`Error: ${error.message}`, 'error');
                        } else {
                            showNotification('Score removed.', 'success');
                            e.target.style.borderColor = '';
                            e.target.closest('.flex').querySelector('.reset-score-btn').disabled = true;
                        }
                    } else {
                        const scoreValue = parseInt(newScore, 10);
                        if (isNaN(scoreValue) || scoreValue < 0 || scoreValue > 100) {
                            showNotification('Please enter a valid score between 0 and 100.', 'error');
                            e.target.style.borderColor = 'red';
                            return;
                        }

                        const { error } = await db.from('scores').upsert({
                            student_id: studentId,
                            quiz_id: quizId,
                            score: scoreValue
                        }, { onConflict: 'student_id, quiz_id' });

                        if (error) {
                            showNotification(`Error: ${error.message}`, 'error');
                            e.target.style.borderColor = 'red';
                        } else {
                            showNotification('Score saved!', 'success');
                            e.target.style.borderColor = 'green';
                            e.target.closest('.flex').querySelector('.reset-score-btn').disabled = false;
                            setTimeout(() => { e.target.style.borderColor = ''; }, 2000);
                        }
                    }
                });
            });

            bodyContainer.querySelectorAll('.reset-score-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    const studentId = btn.dataset.studentId;
                    const quizId = btn.dataset.quizId;
                    const studentName = btn.dataset.studentName;
                    const meetingNumber = btn.dataset.meetingNumber;

                    if (!quizId) return;

                    showConfirmationModal(
                        `Reset Progress`,
                        `Are you sure you want to reset the quiz score for ${studentName} in Meeting ${meetingNumber}? The student will be able to retake the quiz.`,
                        async () => {
                            const { error } = await db.from('scores').delete().match({ student_id: studentId, quiz_id: quizId });
                            if (error) {
                                showNotification('Failed to reset score: ' + error.message, 'error');
                            } else {
                                showNotification(`Score for ${studentName} in Meeting ${meetingNumber} has been reset.`);
                                await renderLecturerScores(); // Refresh the table
                            }
                        }
                    );
                });
            });
            feather.replace();
        }
        
        // UPDATED FUNCTION: Render the "Hubungi Komting" page with edit functionality
        function renderHubungiKomting() {
            const container = document.getElementById('lecturer-komting-content');
            if (!container) return;

            let contentHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Hubungi Ketua Tingkat (Komting)</h1>
                    <div>`;

            if (isKomtingEditMode) {
                contentHTML += `
                        <button id="save-komting-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-all flex items-center shadow-sm">
                            <i data-feather="save" class="w-4 h-4 mr-2"></i> Simpan Perubahan
                        </button>
                        <button id="cancel-komting-btn" class="ml-2 bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition-all flex items-center shadow-sm">
                            <i data-feather="x" class="w-4 h-4 mr-2"></i> Batal
                        </button>
                    `;
            } else {
                contentHTML += `
                        <button id="edit-komting-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-all flex items-center shadow-sm">
                            <i data-feather="edit" class="w-4 h-4 mr-2"></i> Edit Kontak
                        </button>
                    `;
            }

            contentHTML += `
                    </div>
                </div>
                <div id="komting-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">`;

            komtingData.forEach((komting, index) => {
                if (isKomtingEditMode) {
                    contentHTML += `
                        <div class="bg-white p-6 rounded-lg shadow-md flex flex-col komting-edit-card" data-index="${index}">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Nama Program Studi</label>
                                    <input type="text" value="${komting.prodi}" class="komting-prodi-input mt-1 w-full p-2 border border-gray-300 rounded-md font-semibold text-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Nama Komting</label>
                                    <input type="text" value="${komting.nama}" class="komting-nama-input mt-1 w-full p-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                     <label class="block text-sm font-medium text-gray-700">Nomor WhatsApp (Format: 62...)</label>
                                    <input type="text" value="${komting.wa}" class="komting-wa-input mt-1 w-full p-2 border border-gray-300 rounded-md">
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    const pesanMeeting = encodeURIComponent(`Halo ${komting.nama}, mohon diinformasikan ke teman-teman kelas ${komting.prodi} bahwa materi dan tugas baru sudah bisa diakses di platform e-learning. Terima kasih.`);
                    const pesanTugas = encodeURIComponent(`Halo ${komting.nama}, mohon diingatkan kembali teman-teman kelas ${komting.prodi} untuk segera mengerjakan dan mengumpulkan tugas di platform e-learning. Terima kasih.`);

                    contentHTML += `
                        <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                            <h2 class="text-xl font-semibold text-gray-800">${komting.prodi}</h2>
                            <div class="flex-grow mt-2">
                                <p class="text-gray-600 flex items-center">
                                    <i data-feather="user" class="w-4 h-4 mr-2"></i>
                                    ${komting.nama}
                                </p>
                                <p class="text-gray-600 mt-1 flex items-center">
                                    <i data-feather="phone" class="w-4 h-4 mr-2"></i>
                                    <a href="https://wa.me/${komting.wa}" target="_blank" class="text-indigo-600 hover:underline">${komting.wa}</a>
                                </p>
                            </div>
                            <div class="mt-4 pt-4 border-t space-y-2">
                                <p class="text-sm font-medium text-gray-700">Kirim Notifikasi Cepat:</p>
                                <a href="https://wa.me/${komting.wa}?text=${pesanMeeting}" target="_blank" class="w-full flex items-center justify-center bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md transition-all text-sm">
                                    <i data-feather="message-circle" class="w-4 h-4 mr-2"></i>
                                    <span>Info Materi & Tugas Baru</span>
                                </a>
                                <a href="https://wa.me/${komting.wa}?text=${pesanTugas}" target="_blank" class="w-full flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md transition-all text-sm">
                                    <i data-feather="bell" class="w-4 h-4 mr-2"></i>
                                    <span>Ingatkan Pengumpulan Tugas</span>
                                </a>
                            </div>
                        </div>
                    `;
                }
            });

            contentHTML += `</div>`;
            container.innerHTML = contentHTML;
            feather.replace();

            // Add event listeners based on the mode
            if (isKomtingEditMode) {
                document.getElementById('save-komting-btn').addEventListener('click', () => {
                    document.querySelectorAll('.komting-edit-card').forEach(card => {
                        const index = card.dataset.index;
                        const newProdi = card.querySelector('.komting-prodi-input').value;
                        const newName = card.querySelector('.komting-nama-input').value;
                        const newWa = card.querySelector('.komting-wa-input').value;
                        
                        if (newProdi && newName && newWa) {
                            komtingData[index].prodi = newProdi;
                            komtingData[index].nama = newName;
                            komtingData[index].wa = newWa;
                        }
                    });
                    isKomtingEditMode = false;
                    renderHubungiKomting();
                    showNotification('Kontak komting berhasil diperbarui.', 'success');
                });
                document.getElementById('cancel-komting-btn').addEventListener('click', () => {
                    isKomtingEditMode = false;
                    renderHubungiKomting();
                });
            } else {
                document.getElementById('edit-komting-btn').addEventListener('click', () => {
                    isKomtingEditMode = true;
                    renderHubungiKomting();
                });
            }
        }


        async function exportScoresToExcel() {
    showNotification('Mempersiapkan rekapan nilai total...', 'success');

    try {
        // 1. AMBIL SEMUA DATA NILAI DARI SEMUA TABEL
        const [studentsRes, quizzesRes, quizScoresRes, fileScoresRes, essayScoresRes] = await Promise.all([
            db.from('students').select('id, nrp, name').order('name'),
            db.from('quizzes').select('id, meeting'),
            db.from('scores').select('student_id, quiz_id, score'),
            db.from('submissions').select('student_id, score, meeting_number').not('score', 'is', null),
            db.from('essay_submissions').select('student_id, score, meeting_number').not('score', 'is', null)
        ]);

        const students = studentsRes.data || [];
        const quizzes = quizzesRes.data || [];
        const quizScores = quizScoresRes.data || [];
        const fileScores = fileScoresRes.data || [];
        const essayScores = essayScoresRes.data || [];

        // 2. Tentukan ID Kuis untuk UTS (Meeting 8) dan UAS (Meeting 16)
        const utsQuiz = quizzes.find(q => q.meeting == 8);
        const uasQuiz = quizzes.find(q => q.meeting == 16);
        const utsQuizId = utsQuiz ? utsQuiz.id : null;
        const uasQuizId = uasQuiz ? uasQuiz.id : null;

        if (!utsQuizId || !uasQuizId) {
            showNotification("Error: Kuis untuk UTS (M8) atau UAS (M16) belum dibuat.", "error");
            return;
        }

        // 3. FUNGSI UNTUK KONVERSI NILAI KE HURUF
        const konversiNilaiKeHuruf = (nilai) => {
            if (nilai > 80) return 'A';
            if (nilai > 64) return 'B'; // 65 - 80
            if (nilai > 49) return 'C'; // 50 - 64
            if (nilai > 29) return 'D'; // 30 - 49
            return 'E'; // 0 - 29
        };

        // 4. PROSES DATA UNTUK SETIAP MAHASISWA
        const dataForExport = students.map(student => {
            const studentId = student.id;

            // Kumpulkan SEMUA nilai dalam satu array
            let semuaNilai = [];
            
            // --- PERUBAHAN DIMULAI DI SINI ---
            let utsScore = 0; // Variabel terpisah untuk UTS
            let uasScore = 0; // Variabel terpisah untuk UAS
            // --- AKHIR PERUBAHAN ---

            // a. Ambil nilai Kuis Reguler, UTS, dan UAS
            const allQuizScores = quizScores.filter(s => s.student_id === studentId);
            allQuizScores.forEach(s => {
                if (s.quiz_id === utsQuizId) {
                    utsScore = s.score || 0; // Simpan di variabel terpisah
                    semuaNilai.push({ type: 'UTS', score: utsScore });
                } else if (s.quiz_id === uasQuizId) {
                    uasScore = s.score || 0; // Simpan di variabel terpisah
                    semuaNilai.push({ type: 'UAS', score: uasScore });
                } else {
                    semuaNilai.push({ type: 'Kuis', score: s.score || 0 });
                }
            });

            // b. Ambil nilai Tugas File
            fileScores.filter(s => s.student_id === studentId).forEach(s => {
                semuaNilai.push({ type: 'Tugas File', score: s.score || 0 });
            });

            // c. Ambil nilai Tugas Esai
            essayScores.filter(s => s.student_id === studentId).forEach(s => {
                semuaNilai.push({ type: 'Tugas Esai', score: s.score || 0 });
            });

            // 5. HITUNG RATA-RATA TOTAL (logika ini tetap sama)
            let totalNilai = 0;
            let jumlahNilai = semuaNilai.length;
            
            if (jumlahNilai > 0) {
                totalNilai = semuaNilai.reduce((acc, current) => acc + current.score, 0);
            }
            
            const nilaiAkhirRataRata = (jumlahNilai > 0) ? (totalNilai / jumlahNilai) : 0;
            const nilaiHuruf = konversiNilaiKeHuruf(nilaiAkhirRataRata);

            // 6. KEMBALIKAN DATA UNTUK BARIS EXCEL (dengan kolom baru)
            return {
                'NRP': student.nrp,
                'Name': student.name,
                'UTS': utsScore, // Tambahkan kolom UTS
                'UAS': uasScore, // Tambahkan kolom UAS
                'Nilai Rata-Rata': nilaiAkhirRataRata.toFixed(2),
                'Nilai Huruf': nilaiHuruf,
                'Jumlah Nilai Diambil': jumlahNilai,
                'Total Poin': totalNilai
            };
        });

        // 7. BUAT FILE EXCEL
        const worksheet = XLSX.utils.json_to_sheet(dataForExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Rekap Nilai Total");

        // Atur lebar kolom agar lebih rapi (menambahkan UTS dan UAS)
        worksheet['!cols'] = [
            { wch: 15 }, // NRP
            { wch: 30 }, // Name
            { wch: 8 },  // UTS (Baru)
            { wch: 8 },  // UAS (Baru)
            { wch: 15 }, // Nilai Rata-Rata
            { wch: 10 }, // Nilai Huruf
            { wch: 20 }, // Jumlah Nilai Diambil
            { wch: 10 }  // Total Poin
        ];

        XLSX.writeFile(workbook, "Rekap_Nilai_Total_Mahasiswa.xlsx");
        showNotification('Rekapan nilai total berhasil diekspor!', 'success');

    } catch (error) {
        showNotification('Gagal mengekspor data: ' + error.message, 'error');
        console.error("Error exporting scores:", error);
    }
}

        async function handleChangePassword() {
            const { data: { user } } = await db.auth.getUser();
            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;
            
            if (!oldPassword || !newPassword || !confirmNewPassword) {
                showNotification('Please fill all fields', 'error');
                return;
            }
            if (newPassword !== confirmNewPassword) {
                showNotification('New passwords do not match', 'error');
                return;
            }

            // Verify old password by trying to sign in with it
            const { error: signInError } = await db.auth.signInWithPassword({
                email: user.email,
                password: oldPassword,
            });

            if (signInError) {
                showNotification('Old password is not correct', 'error');
                return;
            }

            // Update user's password in Supabase Auth
            const { error: updateError } = await db.auth.updateUser({ password: newPassword });
            
            if (updateError) {
                showNotification('Failed to update password: ' + updateError.message, 'error');
            } else {
                 // Also update the password in the public.students table
                 const { error: tableUpdateError } = await db.from('students').update({ password: newPassword }).eq('id', user.id);
                 if (tableUpdateError){
                      showNotification('Failed to update password in students table: ' + tableUpdateError.message, 'error');
                 } else {
                     showNotification('Password updated successfully!');
                     document.getElementById('change-password-modal').classList.add('hidden');
                     document.getElementById('change-password-form').reset();
                 }
            }
        }

        // --- Initial App Load ---
        async function checkSession() {
    // 1. SELALU mulai dengan mengecek sesi Supabase
    const { data: { session } } = await db.auth.getSession();

    if (session && session.user) {
        // 2. Sesi DITEMUKAN. Cari tahu siapa dia.
        const user = session.user;
        const userRole = user.user_metadata?.role;

        if (userRole === 'lecturer') {
            // 3. Ini DOSEN
            sessionStorage.setItem('user', JSON.stringify({ 
                role: 'lecturer', 
                username: 'Dosen', 
                id: user.id 
            }));
            await fetchRpsData(); // Ambil data RPS
            showLoginPage(false);
            await showLecturerDashboard(true);

        } else {
            // 4. Ini (kemungkinan) MAHASISWA
            const { data: studentData, error } = await db.from('students').select('*').eq('id', user.id).single();

            if (studentData) {
                // 5. Ini MAHASISWA yang valid
                sessionStorage.setItem('user', JSON.stringify({ role: 'student', ...studentData }));
                await fetchRpsData(); // Ambil data RPS
                showLoginPage(false);
                await showStudentDashboard(true);
            } else {
                // 6. Ini PENGGUNA ANEH (terotentikasi tapi bukan dosen & tidak ada di tabel students)
                console.error("User authenticated but no profile found. Logging out.", user.id);
                logout(); // Ini adalah error Anda sebelumnya, tapi sekarang hanya berlaku untuk pengguna aneh
            }
        }
    } else {
        // 7. Tidak ada sesi SAMA SEKALI. Tampilkan login.
        // Hapus sisa data sessionStorage lama (jika ada)
        sessionStorage.removeItem('user'); 
        showLoginPage(true);
    }
}
        
        document.addEventListener('DOMContentLoaded', () => {
             // All event listeners that target specific DOM elements should be inside here.

            

            // --- LECTURER DASHBOARD NAVIGATION ---
            document.querySelectorAll('.lecturer-sidebar-link').forEach(link => {
                link.addEventListener('click', async (e) => {
                    e.preventDefault();

                    const currentActive = document.querySelector('.lecturer-sidebar-link.active');
                    if (currentActive) {
                        currentActive.classList.remove('active');
                    }
                    e.currentTarget.classList.add('active');

                    // Hide all content tabs
                    document.querySelectorAll('.lecturer-tab-content').forEach(tab => tab.classList.add('hidden'));

                    // Show the target content tab
                    const contentId = e.currentTarget.dataset.content;
                    const targetContent = document.getElementById(contentId);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }

                    // Fetch data for the selected tab
                    switch (contentId) {
                        case 'lecturer-students-content':
                            await renderLecturerStudents();
                            break;
                        case 'lecturer-attendance-content':
                            await renderLecturerAttendance();
                            break;
                        case 'lecturer-submissions-content':
                            await renderLecturerSubmissions(document.getElementById('submission-meeting-select').value);
                            break;
                        case 'lecturer-scores-content':
                            await renderLecturerScores();
                            break;
                        case 'lecturer-modules-content':
                             await renderLecturerModules();
                             break;
                        // NEW CASE for Hubungi Komting
                        case 'lecturer-komting-content':
                            renderHubungiKomting();
                            break;
                    }
                });
            });

            // --- MATERIAL MODAL LISTENERS ---
            document.getElementById('cancel-material').addEventListener('click', () => {
                document.getElementById('material-modal').classList.add('hidden');
            });
            document.getElementById('save-material').addEventListener('click', saveMaterial);
            
            // --- QUIZ BUILDER LISTENERS ---
            document.getElementById('cancel-quiz-builder').addEventListener('click', () => document.getElementById('quiz-builder-modal').classList.add('hidden'));
            document.getElementById('save-quiz').addEventListener('click', saveQuiz);
            document.getElementById('add-question').addEventListener('click', () => addQuestionField());
            document.getElementById('add-instruction').addEventListener('click', () => addInstructionField());
            document.getElementById('add-passage').addEventListener('click', () => addPassageField());
            document.getElementById('add-media').addEventListener('click', () => addMediaField());
            
            // --- MAIN DASHBOARD LISTENERS ---
            document.getElementById('show-register').addEventListener('click', () => {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            });

            document.getElementById('back-to-login').addEventListener('click', () => {
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            });

            document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('username').value; // Ini bisa NRP atau guru123
    const password = document.getElementById('password').value;

    let emailToLogin;
    let isLecturerLogin = false;

    // "TRIK" KITA ADA DI SINI:
    // Cek apakah ini Dosen yang mencoba login?
    if (username === 'guru123') {
        isLecturerLogin = true;
        emailToLogin = 'dosen@elearning.com'; // Kita gunakan email "asli"
    } else {
        // Jika bukan, anggap ini Mahasiswa
        emailToLogin = `${username}@elearning.com`;
    }

    // Coba login ke Supabase dengan email dan password
    // Jika Dosen: Supabase akan cek 'dosen@elearning.com' dengan password 'guru123'
    // Jika Mhs: Supabase akan cek 'nrp@elearning.com' dengan password mhs
    const { data: authData, error: authError } = await db.auth.signInWithPassword({ 
        email: emailToLogin, 
        password: password 
    });

    if (authError) {
        // Jika login Dosen gagal, beri pesan spesifik
        if (isLecturerLogin) {
            showNotification('Login Dosen gagal. Pastikan password guru123 Anda sama dengan di Supabase.', 'error');
        } else {
            showNotification('Invalid Student ID or password', 'error');
        }
        return;
    }

    // Jika login berhasil, cek role-nya
    if (authData.user) {
        // Cek role dari metadata (untuk Dosen) atau dari flag (untuk Mahasiswa)
        const userRole = authData.user.user_metadata?.role;

        if (userRole === 'lecturer' || isLecturerLogin) {
            // --- INI LOGIKA UNTUK DOSEN ---
            sessionStorage.setItem('user', JSON.stringify({ 
                role: 'lecturer', 
                username: 'Dosen', 
                id: authData.user.id 
            }));

            await fetchRpsData(); // Ambil data RPS

            showLoginPage(false);
            await showLecturerDashboard(true);

        } else {
            // --- INI LOGIKA UNTUK MAHASISWA (yang sudah ada) ---
            const { data: studentData, error: studentError } = await db.from('students').select('*').eq('id', authData.user.id).single();
            if (studentError || !studentData) {
                showNotification('Could not find student profile.', 'error');
                await db.auth.signOut(); // Logout paksa jika profil tidak ada
                return;
            }
            sessionStorage.setItem('user', JSON.stringify({ role: 'student', ...studentData }));
            await fetchRpsData();
            showLoginPage(false);
            await showStudentDashboard(true);
        }
    } else {
        showNotification('Invalid credentials.', 'error');
    }
});

            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const nrp = document.getElementById('reg-nrp').value;
                const name = document.getElementById('reg-name').value;
                const password = document.getElementById('reg-password').value;
                const confirmPassword = document.getElementById('reg-confirm-password').value;
                if (password !== confirmPassword) {
                    showNotification('Passwords do not match', 'error');
                    return;
                }
                const { data: existingStudent } = await db.from('students').select('nrp').eq('nrp', nrp).single();
                if (existingStudent) {
                    showNotification('Student ID already registered', 'error');
                    return;
                }
                const { data, error } = await db.auth.signUp({
                    email: `${nrp}@elearning.com`,
                    password: password,
                    options: { data: { nrp: nrp, full_name: name } }
                });
                if (error) {
                    showNotification('Registration failed: ' + error.message, 'error');
                } else if (data.user) {
                    const { error: insertError } = await db.from('students').insert([{ id: data.user.id, nrp: nrp, name: name, password: password }]);
                    if (insertError) {
                         showNotification('Registration failed on student table: ' + insertError.message, 'error');
                    } else {
                        showNotification('Registration successful! Please login.');
                        document.getElementById('register-form').reset();
                        document.getElementById('register-form').classList.add('hidden');
                        document.getElementById('login-form').classList.remove('hidden');
                    }
                } else {
                     showNotification('Registration failed: could not create user.', 'error');
                }
            });

            document.getElementById('student-logout').addEventListener('click', logout);
            document.getElementById('lecturer-logout').addEventListener('click', logout);
            
            const attendanceSelect = document.getElementById('attendance-meeting-select');
            if (attendanceSelect) {
                 
                 attendanceSelect.addEventListener('change', () => renderLecturerAttendance());
            }
            
            const submissionSelect = document.getElementById('submission-meeting-select');
            if(submissionSelect){
                 
                 submissionSelect.addEventListener('change', (e) => renderLecturerSubmissions(e.target.value));
            }
            
            document.getElementById('export-scores-btn').addEventListener('click', exportScoresToExcel);
            
            document.getElementById('change-password-btn').addEventListener('click', () => {
                document.getElementById('change-password-modal').classList.remove('hidden');
                document.getElementById('change-password-form').reset();
            });

            document.getElementById('cancel-change-password').addEventListener('click', () => {
                document.getElementById('change-password-modal').classList.add('hidden');
            });
            
            document.getElementById('save-new-password').addEventListener('click', handleChangePassword);
            // Listener untuk modal RPS (Edit Judul Meeting)
document.getElementById('save-rps-btn').addEventListener('click', saveRpsChanges);
document.getElementById('cancel-rps-btn').addEventListener('click', closeRpsEditModal);
document.getElementById('close-essay-viewer-btn').addEventListener('click', () => {
    document.getElementById('essay-viewer-modal').classList.add('hidden');
});
            document.getElementById('cancel-action-btn').addEventListener('click', () => {
                document.getElementById('confirmation-modal').classList.add('hidden');
            });

            document.getElementById('close-quiz-taker').addEventListener('click', () => {
                if (quizTimerInterval) clearInterval(quizTimerInterval);
                document.getElementById('quiz-taker-modal').classList.add('hidden');
            });

            document.getElementById('confirm-action-btn').addEventListener('click', () => {
                if (typeof confirmActionCallback === 'function') {
                    confirmActionCallback();
                }
                document.getElementById('confirmation-modal').classList.add('hidden');
            });
            
            document.getElementById('my-scores-btn').addEventListener('click', async () => {
    document.querySelectorAll('.module-item').forEach(item => item.classList.remove('active'));
    const detailContainer = document.getElementById('student-module-detail');
    detailContainer.innerHTML = `<div>Loading scores...</div>`;

    const user = JSON.parse(sessionStorage.getItem('user'));

    // --- AWAL MODIFIKASI ---
    // 1. Ambil SEMUA data skor dan data pendukungnya
    const [quizScoresRes, quizzesRes, fileSubmissionsRes, essaySubmissionsRes] = await Promise.all([
        db.from('scores').select('*').eq('student_id', user.id), // Nilai Kuis
        db.from('quizzes').select('id, meeting, title'), // Info Kuis
        db.from('submissions').select('meeting_number, score').eq('student_id', user.id).not('score', 'is', null), // Nilai Tugas File
        db.from('essay_submissions').select('meeting_number, score').eq('student_id', user.id).not('score', 'is', null) // Nilai Tugas Esai
    ]);

    if (quizScoresRes.error || quizzesRes.error || fileSubmissionsRes.error || essaySubmissionsRes.error) {
        detailContainer.innerHTML = `<p class="text-red-500">Error loading scores.</p>`;
        console.error("Error fetching scores:", quizScoresRes.error, quizzesRes.error, fileSubmissionsRes.error, essaySubmissionsRes.error);
        return;
    }

    const quizScores = quizScoresRes.data || [];
    const quizzes = quizzesRes.data || [];
    const fileSubmissions = fileSubmissionsRes.data || [];
    const essaySubmissions = essaySubmissionsRes.data || [];

    // 2. Gabungkan semua skor ke dalam satu array
    let allScores = [];
    let totalScore = 0;

    // Proses Nilai Kuis
    quizScores.forEach(score => {
        const quiz = quizzes.find(q => q.id === score.quiz_id);
        if (quiz) {
            allScores.push({
                meeting: quiz.meeting,
                title: quiz.title,
                type: (quiz.meeting === 8 || quiz.meeting === 16) ? 'Exam' : 'Quiz',
                score: score.score
            });
            totalScore += score.score;
        }
    });

    // Proses Nilai Tugas File
    fileSubmissions.forEach(sub => {
        allScores.push({
            meeting: sub.meeting_number,
            title: 'File Submission',
            type: 'Assignment',
            score: sub.score
        });
        totalScore += sub.score;
    });

    // Proses Nilai Tugas Esai
    essaySubmissions.forEach(sub => {
        allScores.push({
            meeting: sub.meeting_number,
            title: 'Essay Submission',
            type: 'Assignment',
            score: sub.score
        });
        totalScore += sub.score;
    });

    // 3. Urutkan semua skor berdasarkan nomor pertemuan
    allScores.sort((a, b) => a.meeting - b.meeting);
    // --- AKHIR MODIFIKASI ---

    let scoresHTML = `<h3 class="text-3xl font-bold text-gray-800 mb-6">My Scores</h3>`;
    let scoreCount = allScores.length; // Gunakan panjang array gabungan

    if (scoreCount > 0) {
        scoresHTML += `<div class="overflow-x-auto bg-white rounded-lg shadow"><table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Meeting</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assessment</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">`;

        // Ganti loop lama dengan loop baru
        allScores.forEach(score => {
            scoresHTML += `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Meeting ${score.meeting}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${score.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${score.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-indigo-600">${score.score}</td>
                </tr>
            `;
        });
        
        scoresHTML += `</tbody></table></div>`;
        
        // Kalkulasi rata-rata baru
        if (scoreCount > 0) {
            const averageScore = (totalScore / scoreCount).toFixed(2);
            scoresHTML += `<div class="mt-6 p-4 bg-gray-100 rounded-lg text-right">
                <span class="text-gray-600 font-medium">Average Score (All Tasks):</span>
                <span class="text-2xl font-bold text-indigo-700 ml-2">${averageScore}</span>
            </div>`;
        }

    } else {
        // Ubah pesan error
        scoresHTML += `<p class="text-center text-gray-500">You do not have any scores recorded yet.</p>`;
    }

    detailContainer.innerHTML = scoresHTML;
});


            // Start the clock
            updateClock();
            setInterval(updateClock, 1000);

            checkSession();
        });
    </script>
    <div id="rps-edit-modal" class="modal fixed inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-backdrop"></div>
            <div class="bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full z-50">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="rps-modal-title">Edit Meeting Details</h3>
                    <form id="rps-edit-form" class="mt-4 space-y-4">
                        <input type="hidden" id="rps-week-id">
                        
                        <div>
                            <label for="rps-topic" class="block text-sm font-medium text-gray-700">Meeting Title (Topic)</label>
                            <input type="text" id="rps-topic" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="rps-description" class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea id="rps-description" rows="3" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                        </div>
                    </form>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse items-center">
                    <button type="button" id="save-rps-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:ml-3">Save Changes</button>
                    <button type="button" id="cancel-rps-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
